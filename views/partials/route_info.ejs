<div class="modal fade" id="facebookModal" tabindex="-1" role="dialog" aria-labelledby="facebookModal">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">Copy and paste Facebook Post</h4>
          <hr>
      </div>
      <div class="modal-body">
        <% days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"] %>
        <div>
          <div>Driving to <%= routeData.destination %> on <%= days[routeData.date.getDay()] + " " + (routeData.date.getMonth() + 1) + "/" + routeData.date.getDate() %> around <%= routeData.time %>. <%= routeData.seats %> spots available, $<%= routeData.inconvenience %> per seat.</div>
          <br>
          <div>To all interested riders, enter your drop-off location in the link below. PM me if you have any questions!</div>
        </div>
        <a id="selfLink"></a>
      </div>
        <hr>
      <div class="modal-footer">
        <input type="submit" class="btn btn-primary" data-dismiss="modal" value="Done">
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="setUpPaymentModal" tabindex="-1" role="dialog" aria-labelledby="setUpPaymentModal">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">Set up payment methods</h4>
      </div>
      <div class="modal-body">
        Stuff for setting up deposit
      </div>
      <div class="modal-footer">
        <input type="submit" class="btn btn-primary" data-dismiss="modal" value="Done">
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="paymentModal" tabindex="-1" role="dialog" aria-labelledby="paymentModal">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">Modal for paying</h4>
      </div>
      <div class="modal-body">
        <form id="checkout-form" action="/checkout" method="post">
          <div id="error-message"></div>

          <label for="card-number">Card Number</label>
          <div class="hosted-field" id="card-number"></div>

          <label for="cvv">CVV</label>
          <div class="hosted-field" id="cvv"></div>

          <label for="expiration-date">Expiration Date</label>
          <div class="hosted-field" id="expiration-date"></div>

          <input type="hidden" name="payment_method_nonce">
          <input type="hidden" name="amount">
          <input type="hidden" name="routeId" value="<%= routeId %>">
          <input id="payButton" type="submit" value="Pay $10" disabled>
        </form>

        <!-- Load the Client component. -->
        <script src="https://js.braintreegateway.com/web/3.11.0/js/client.min.js"></script>

        <!-- Load the Hosted Fields component. -->
        <script src="https://js.braintreegateway.com/web/3.11.0/js/hosted-fields.min.js"></script>

        <script>
        // We generated a client token for you so you can test out this code
        // immediately. In a production-ready integration, you will need to
        // generate a client token on your server (see section below).
        $.get('/client_token', function(authorization) {
          var submit = document.getElementById('payButton');
          var form = document.getElementById('checkout-form');

          console.log("going");
          braintree.client.create({
            authorization: authorization
          }, function (clientErr, clientInstance) {
            console.log("called");
            if (clientErr) {
              console.log(clientErr);
              return;
            }

            braintree.hostedFields.create({
              client: clientInstance,
              styles: {
                'input': {
                  'font-size': '14pt'
                },
                'input.invalid': {
                  'color': 'red'
                },
                'input.valid': {
                  'color': 'green'
                }
              },
              fields: {
                number: {
                  selector: '#card-number',
                  placeholder: '4111 1111 1111 1111'
                },
                cvv: {
                  selector: '#cvv',
                  placeholder: '123'
                },
                expirationDate: {
                  selector: '#expiration-date',
                  placeholder: '10/2019'
                }
              }
            }, function (hostedFieldsErr, hostedFieldsInstance) {
              console.log("called 2");
              if (hostedFieldsErr) {
                console.log(hostedFieldsErr);
                // Handle error in Hosted Fields creation
                return;
              }
              console.log("submit", submit);
              submit.removeAttribute('disabled');

              form.addEventListener('submit', function (event) {
                event.preventDefault();

                hostedFieldsInstance.tokenize(function (tokenizeErr, payload) {
                  if (tokenizeErr) {
                    // Handle error in Hosted Fields tokenization
                    return;
                  }

                  // Put `payload.nonce` into the `payment_method_nonce` input, and then
                  // submit the form. Alternatively, you could send the nonce to your server
                  // with AJAX.
                  console.log('nonce', payload.nonce);
                  document.querySelector('input[name="payment_method_nonce"]').value = payload.nonce;
                  document.querySelector('input[name="amount"]').value = "10";
                  form.submit();
                });
              }, false);
            });
          });
        });
        </script>

      </div>
      <div class="modal-footer">
        <input type="submit" class="btn btn-primary" data-dismiss="modal" value="Done">
      </div>
    </div>
  </div>
</div>


<div class="modal fade" id="lessThanZeroSeats" tabindex="-1" role="dialog" aria-labelledby="lessThanZeroSeats">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="lessThanZeroSeatsTitle">You've already confirmed <%= routeData.confirmedRiders.length %> riders</h4>
      </div>
      <div class="modal-body">
        If you can no longer take some riders, please let them know ASAP.
      </div>
      <div class="modal-footer">
        <input type="submit" class="btn btn-primary" data-dismiss="modal" value="Done">
      </div>
    </div>
  </div>
</div>

<!--Rider view, use ejs to check if their facebook credentials is the original Facebook user or not-->
<div class="col-md-4" style="overflow: scroll; height:100%">
    <div>
        <div style="background-color:#c5d9f9; border-radius: 5px">
          <h2>
            <a href="<%= routeData.driver.facebook.link %>">
              <% var src = "" %>
              <% if (routeData.driver.facebook.photos && routeData.driver.facebook.photos.length > 0 && routeData.driver.facebook.photos[0].value) { src = routeData.driver.facebook.photos[0].value; } %>
              <img align="middle" src="<%= src %>"></img>
            </a>
            <%= routeData.driver.facebook.name.split(' ')[0] %>'s Route
          </h2>
        </div>

        <form class="row" action="rider"></form>
        <% if (user) { %>
          <% if (isDriver) { %>
            <div class="panel panel-default" >
              <div class="panel-heading" id="link-panel">
                  <div class="col-md-6">
                      <a class="btn btn-md" onclick="toggleShareableLink()" href="javascript:void(0);">
                        <span id="getLinkText">Copy link</span>  <span class="glyphicon glyphicon-paperclip" > </span>
                      </a>
                  </div>
                  <div class="col-md-6" id="copy-link" align="right">
                      <a class="btn btn-md" onclick="showFBModal()" href="javascript:void(0);"> Show Post </a>
                  </div>
              </div>
              <div id="shareableLink" class="panel-body getlink-container" style="display:none">
                  <input onClick="select()"  class=" form-control" readonly="readonly" value="http://localhost:5000/route?id=<%= routeData.shortId || routeData._id %>"> </input>
              </div>
            </div>
          <% } else { %>
            <% var location = ""; %>
            <% if (user && routeData.dropOffs) { %>
             <% location = routeData.dropOffs[user._id] %>
            <% } %>
            <div id="dropOffTextEditable" style="display:none">
              <form action="javascript:return false">
                <span> <i class="material-icons">place</i> </span> <input id="pac-input" style="width:60%;" name="address" class="controls" type="text" placeholder="Enter dropoff address..." value="<%=location %>" autofocus>
                <input type="hidden" name="routeId" value="<%= routeId %>">
                <button type="button" class="btn btn-primary btn-sm editable-submit" onclick="javascript:riderLocationChanged()">
                  <i class="glyphicon glyphicon-ok"></i>
                </button>
                <button type="button" class="btn btn-default btn-sm editable-cancel" onclick="javascript:editableDone(false, 'dropOff')">
                  <i class="glyphicon glyphicon-remove"></i>
                </button>
                <br><br>
              </form>
            </div>
            <div id="dropOffText" style="display:none">
              <% if (confirmedRider) { %>
                <!--<text>You've got a ride with <%= routeData.driver.facebook.name.split(' ')[0] %> to</text>
                <span class="<%= confirmedRider ? "" : 'editableInput' %>"><%= location %></span>-->
              <% } else { %>
                <text>You've requested a ride with <%= routeData.driver.facebook.name.split(' ')[0] %> to</text>
                <span class="<%= confirmedRider ? "" : 'editableInput' %>"><%= location %></span>
              <% } %>

            </div>
            <% if (confirmedRider && !routeData.riderStatus[user._id].paid) { %>
              <button type="button" class="btn btn-primary" onclick="showPaymentModal()">Pay initial deposit</button>
              <div style="font-size:18px" id="countDown">2hr</div>
              <div>The driver may drop you if you don't put up the intial deposit on time</div>
            <% } %>
          <% } %>
        <% } else {  %>
          <a href="/auth/facebook?redirect=<%= encodeURIComponent('/route?id=' + (routeData.shortId || routeData._id)) %>")>
            Login to Facebook to <%= routeData.confirmedRiders.length >= routeData.seats ? "join the waitlist" : "request a ride" %>
          </a>
        <% } %>

        <br>
        <hr style="height: 3px; background-color: gray">

        <div id="rideIsFull" style="display:none">
          <button class="info btn <%= isDriver ? 'btn-success' : 'btn-danger'; %>" style="background-color:black">Ride is FULL</button>
        </div>
        <br>

        <div class="form-inline editableform">
          <div id="originTextEditable" style="display:none">
            <i class="material-icons" style="font-size:18px">my_location</i>
            <input id="editOriginInput" type="text" class="form-control input-sm" style="width:60%" value="<%= routeData.origin %>" onkeydown="if (event.keyCode == 13) { editableDone(true, 'origin'); }">
            <button type="button" class="btn btn-primary btn-sm editable-submit" onclick="javascript:editableDone(true, 'origin')">
              <i class="glyphicon glyphicon-ok"></i>
            </button>
            <button type="button" class="btn btn-default btn-sm editable-cancel" onclick="javascript:editableDone(false, 'origin')">
              <i class="glyphicon glyphicon-remove"></i>
            </button>
          </div>
          <div id="originText" style="font-size:18px">
            <i class="material-icons" style="font-size:18px">my_location</i>
            <span class="<%= isDriver ?'editableInput' : '' %>"><%= routeData.origin %></span>
          </div>
        </div>

        <i class="material-icons" style="font-size:18px">arrow_downward</i><br>

        <div class="form-inline editableform">
          <div id="destinationTextEditable" style="display:none">
            <i class="material-icons" style="font-size:18px">my_location</i>
            <input id="editDestinationInput" type="text" class="form-control input-sm" style="width:60%" value="<%= routeData.destination %>"  onkeydown="if (event.keyCode == 13) { editableDone(true, 'destination'); }">
            <button type="button" class="btn btn-primary btn-sm editable-submit" onclick="javascript:editableDone(true, 'destination')">
              <i class="glyphicon glyphicon-ok"></i>
            </button>
            <button type="button" class="btn btn-default btn-sm editable-cancel" onclick="javascript:editableDone(false, 'destination')">
              <i class="glyphicon glyphicon-remove"></i>
            </button>
          </div>
          <div id="destinationText" style="font-size:18px">
            <i class="material-icons" style="font-size:18px">place</i>
            <span class="<%= isDriver ?'editableInput' : '' %>"><%= routeData.destination %></span>
          </div>
        </div>

        <br>


        <div class="form-inline editableform">
          <div id="seatsTextEditable" style="display:none">
            <i class="material-icons" style="font-size:18px">event_seat</i>
            <span style="">Total riders you can take:</span>
            <input id="editSeatsInput" type="text" class="form-control input-sm" value="<%= routeData.seats %>"  onkeydown="if (event.keyCode == 13) { editableDone(true, 'seats'); }">
            <button type="button" class="btn btn-primary btn-sm editable-submit" onclick="javascript:editableDone(true, 'seats')">
              <i class="glyphicon glyphicon-ok"></i>
            </button>
            <button type="button" class="btn btn-default btn-sm editable-cancel" onclick="javascript:editableDone(false, 'seats')">
              <i class="glyphicon glyphicon-remove"></i>
            </button>
          </div>

          <div id="seatsText" style="">
            <i class="material-icons" style="font-size:18px">event_seat</i>
            <text style="font-size:18px">Seats left: </text>
            <span style="font-size:18px" class="<%= isDriver ?'editableInput' : '' %>">
              <%= routeData.seats - routeData.confirmedRiders.length %>
            </span>
          </div>
        </div>


        <div class="form-inline editableform">
          <div id="dateTextEditable" style="display:none">
            <i class="material-icons" style="font-size:18px">event</i>
            <input id="editDateInput" type="text" class="form-control input-sm" value="<%= (routeData.date.getMonth() + 1) + '/' + routeData.date.getDate() + '/' +  routeData.date.getFullYear() %>"  onkeydown="if (event.keyCode == 13) { editableDone(true, 'date'); }">
            <button type="button" class="btn btn-primary btn-sm editable-submit" onclick="javascript:editableDone(true, 'date')">
              <i class="glyphicon glyphicon-ok"></i>
            </button>
            <button type="button" class="btn btn-default btn-sm editable-cancel" onclick="javascript:editableDone(false, 'date')">
              <i class="glyphicon glyphicon-remove"></i>
            </button>
          </div>

          <div id="dateText" style="">
            <i class="material-icons" style="font-size:18px">event</i>
            <span style="font-size:18px" class="<%= isDriver ?'editableInput' : '' %>">
              <%= (routeData.date.getMonth() + 1) + '/' + routeData.date.getDate() + '/' +  routeData.date.getFullYear() %>
            </span>
          </div>
        </div>

        <div class="form-inline editableform">
          <div id="timeTextEditable" style="display:none">
            <i class="material-icons" style="font-size:18px">event</i>
            <input id="editTimeInput" type="text" class="form-control input-sm" value="<%= routeData.time %>"  onkeydown="if (event.keyCode == 13) { editableDone(true, 'time'); }">
            <button type="button" class="btn btn-primary btn-sm editable-submit" onclick="javascript:editableDone(true, 'time')">
              <i class="glyphicon glyphicon-ok"></i>
            </button>
            <button type="button" class="btn btn-default btn-sm editable-cancel" onclick="javascript:editableDone(false, 'time')">
              <i class="glyphicon glyphicon-remove"></i>
            </button>
          </div>

          <div id="timeText" style="">
            <i class="material-icons" style="font-size:18px">access_time</i>
            <span style="font-size:18px" class="<%= isDriver ?'editableInput' : '' %>">
              <%= routeData.time %>
            </span>
          </div>
        </div>


        <div id="costText" style="">
          <i class="material-icons" style="font-size:18px">attach_money</i>
          <span style="font-size:18px">
            <%= routeData.inconvenience %>
          </span>
        </div>

        <div id="infoText" style="font-size:18px; padding-left: 20px; font-weight: bold"></div>

        <br><br>
        <div id="tableDiv" class="container-fluid row">
            <table class="table table-striped table-hover">
                <thead>
                <tr>
                    <th>#</th>
                    <th> Rider </th>
                    <th> Status </th>
                </tr>
                </thead>
                <tbody id="riderTable"></tbody>
            </table>
            <p style="display:none" id="tableMessage"></p>
        </div>
    </div>
</div>
