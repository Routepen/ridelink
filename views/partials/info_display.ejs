<% include ./displays/location_display %>
<% include ./displays/date_display %>
<% include ./displays/text_display %>
<% include ./displays/time_display %>
<% include ./displays/stops %>


function InfoDisplay(routeData, mapHandler) {
  this.routeData = routeData;
  this.mapHandler = mapHandler;

  this.stopLocations = {};
  this.count = 0;

  this.callbacks = {};
}


InfoDisplay.prototype.setUpEditability = function() {
  <% if (isDriver  && view != "rider") { %>

    var me = this;

    var originDisplay = new LocationDisplay("originText", "origin", this.mapHandler);
    originDisplay.addListener('valueChanged', function(newValue) {
        me.routeData.origin = newValue;
        me.valueChanged("origin", newValue);
        me.mapHandler.drawMap();
    });

    var destinationDisplay = new LocationDisplay("destinationText", "destination", this.mapHandler);
    destinationDisplay.addListener('valueChanged', function(newValue) {
        me.routeData.destination = newValue;
        me.valueChanged("destination", newValue);
        me.mapHandler.drawMap();
    });

    var textDisplay = new TextDisplay("seatsText", "seats");
    textDisplay.addListener('valueChanged', function(newValue) {
        me.routeData.seats = newValue;
        me.valueChanged("seats", newValue);
    });

    var dateDisplay = new DateDisplay("dateText", "date");
    dateDisplay.addListener('valueChanged', function(newValue) {
        me.routeData.date = newValue;
        me.valueChanged("date", newValue);
    });

    var timeDisplay = new TimeDisplay("timeText", "time");
    timeDisplay.addListener('valueChanged', function(newValue) {
      me.routeData.date = newValue;
      me.valueChanged("time", newValue);
    });

    var stops = new Stops(this.routeData.stops, this.mapHandler);
    stops.setUpStops();
    stops.addListener('valueChanged', function(newValue) {
      me.routeData.stops = newValue;
      me.mapHandler.drawMap();
      me.valueChanged("stops[]", newValue);
    });

  <% } %>
}

InfoDisplay.prototype.errorMessageFromEditable = function(id, newValue){
  if (id == "seats" && newValue != "" + parseInt(newValue)) { return "Please enter a number for the number of people you can take"; }
  if (id == "date" && newValue.split('/').length != 3) { return "Please enter a valid date"; }
  if (id == "time" && newValue == "") { return "Please enter the time you are leaving"; }

  return "";
}

InfoDisplay.prototype.restoreMapText = function(id) {
  selector = "#" + id;
  var textDiv = $(selector + 'Text');
  var editableDiv = $(selector + 'TextEditable');
  var span = textDiv.find('span');
  var input = editableDiv.find('input');
  var newValue = input.val().trim();
  span.html(newValue);
  textDiv.show();
  editableDiv.hide();

  var data = {
    routeId: routeData._id,
    updating: id,
    distance: mapHandler.distance
  };
  data[id] = newValue;

  $.post("/route/update", data, function(data) {
    routeData.originCoor = data.originCoor;
    routeData.destinationCoor = data.destinationCoor;
  });
}

InfoDisplay.prototype.mapEditableDone = function(submit, id) {
  if (submit) {
    mapHandler.changeRoute(id);
  }
  else {
    var selector = "#" + id;
    var textDiv = $(selector + 'Text');
    var editableDiv = $(selector + 'TextEditable');
    var span = textDiv.find('span');
    var input = editableDiv.find('input');

    if (id == "dropOff") {
      <% if (isRider) { %>
        input.val(span.html().trim());
        textDiv.show();
        editableDiv.hide();
      <% } else { %>
        input.val("");
      <% } %>
    }
    else {
      input.val(span.html().trim());
      textDiv.show();
      editableDiv.hide();
    }
  }
}

InfoDisplay.prototype.editableDone = function(submit, id) {
  selector = "#" + id;
  var textDiv = $(selector + 'Text');
  var editableDiv = $(selector + 'TextEditable');
  var span = textDiv.find('span');
  var input = editableDiv.find('input');
  var newValue = input.val().trim();

  var error = errorMessageFromEditable(id, newValue);

  if (error == "" || !submit) {
    if (submit) {
      var toSet = newValue;
      if (id == "seats") {
        toSet -= routeData.confirmedRiders.length;
        if (toSet < 0) {
          $("#lessThanZeroSeats").modal('show');
          input.val(routeData.confirmedRiders.length);
          toSet = 0;
          newValue = routeData.confirmedRiders.length;
        }
        if (toSet == 0) {
          $('#rideIsFull').show();
        }
        else {
          $('#rideIsFull').hide();
        }
      }
      if (id == "time") {
        // var parts = toSet.split(":");
        // var s = parseInt(parts[0]);
        // if (!isNaN(s)) {
        //   if (s == 0) {
        //     t =  "12:" + parts[1] + " AM";
        //   }
        //   else if (s < 12) { toSet += " AM"; }
        //   else if (s == 12) { toSet += " PM"; }
        //   else {
        //     if (parts.length > 1) {
        //         toSet = (s-12) + ":" + parts[1] + " PM";
        //     }
        //   }
        // }
      }

      span.html(toSet);
      textDiv.show();
      editableDiv.hide();

      var data = {
        routeId: routeData._id,
        updating: id
      };
      data[id] = newValue;

      $.post("/route/update", data, function() {
        routeData[id] = newValue;
        setUpTable();
        mapHandler.setMarkers();
      });
    }
    else {
      var html = span.html().trim();
      input.val(html);
      textDiv.show();
      editableDiv.hide();
    }
    $('#alertbox').hide();
  }
  else {
    $('#errorMessage').html(error);
    $('#alertbox').show();
  }
}

InfoDisplay.prototype.restoreTdElement = function(riderId, status) {
  var divId = 'tr' + riderId + 'Text';
  var editableId = divId + 'Editable';
  $('#' + divId).show();
  $('#' + editableId).hide();
}

InfoDisplay.prototype.sendStopsToServer = function() {
  var stopList = [];
  for (key in stopLocations) {
    stopList.push(stopLocations[key].find('span').html());
  }

  var data = {
    routeId: routeData._id,
    stops: stopList,
    updating: "stops[]",
    distance: mapHandler.distance
  }

  $.post("/route/update", data, function(data, result) {
    routeData.stopsCoor = data.stopsCoor;
  });
}


// "private" functions that call callbacks after specific events occur
InfoDisplay.prototype.valueChanged = function(name, value) {
  if (this.callbacks.valueChanged) { this.callbacks.valueChanged(name, value); }
  else { console.log("Warning. valueChanged callback undefined"); }
}

InfoDisplay.prototype.addListener = function(event, cb) {
  this.callbacks[event] = cb;
}
