{"version":3,"sources":["index.js"],"names":[],"mappings":"AAAA;;AACA,MAAM,UAAU,QAAQ,SAAR,CAAhB;AACA,MAAM,aAAa,QAAQ,aAAR,CAAnB;AACA,MAAM,UAAU,QAAQ,SAAR,CAAhB;AACA,MAAM,KAAK,QAAQ,IAAR,CAAX;AACA,MAAM,WAAW,QAAQ,UAAR,CAAjB;AACA,MAAM,eAAe,QAAQ,eAAR,CAArB;AACA,MAAM,UAAU,QAAQ,iBAAR,CAAhB;AACA,MAAM,OAAO,QAAQ,eAAR,CAAb;AACA,MAAM,QAAQ,QAAQ,gBAAR,CAAd;AACA,MAAM,iBAAiB,QAAQ,yBAAR,CAAvB;AACA,MAAM,IAAI,QAAQ,QAAR,CAAV;AACA,MAAM,MAAM,SAAZ;;AAEA,MAAM,OAAO,QAAQ,QAAR,CAAb;AACA,MAAM,OAAO,QAAQ,QAAR,CAAb;AACA,MAAM,UAAU,QAAQ,YAAR,CAAhB;;AAEA,SAAS,OAAT,GAAmB,QAAQ,UAAR,CAAnB;AACA,IAAI,OAAO,SAAS,gBAAT,CAA0B,yCAA1B,CAAX;AACA,SAAS,OAAT,CAAiB,wEAAjB,EAA4F;AAC1F,SAAQ;AACN,iBAAe;AACb,oBAAiB,CADJ;AAEb,qBAAkB;AAFL;AADT;AADkF,CAA5F;AAQA,IAAI,KAAK,SAAS,UAAlB;;AAEA;;;;;;;AAQA,GAAG,EAAH,CAAM,OAAN,EAAe,QAAQ,KAAR,CAAc,IAAd,CAAmB,OAAnB,EAA4B,mBAA5B,CAAf;AACA,GAAG,IAAH,CAAQ,MAAR,EAAgB,YAAW;AAC1B,SAAQ,GAAR,CAAY,kBAAZ;AACA,CAFD;;AAKA,IAAI,GAAJ,CAAQ,MAAR,EAAiB,QAAQ,GAAR,CAAY,IAAZ,IAAoB,IAArC;AACA,IAAI,GAAJ,CAAQ,aAAR,EAAuB,KAAvB;;AAEA,IAAI,GAAJ,CAAQ,QAAQ,MAAR,CAAe,YAAY,SAA3B,CAAR;AACA;AACA,IAAI,GAAJ,CAAQ,WAAW,UAAX,CAAsB,EAAC,UAAU,KAAX,EAAtB,CAAR;;AAEA;AACA,IAAI,GAAJ,CAAQ,QAAQ;AACf,SAAQ,IADO;AAEf,oBAAmB,IAFJ;AAGf,SAAQ;AAHO,CAAR,CAAR;AAKA,IAAI,GAAJ,CAAQ,cAAR;;AAEA;AACA,IAAI,GAAJ,CAAQ,WAAW,IAAX,EAAR;;AAEA,KAAK,SAAL,CAAe,GAAf;AACA,QAAQ,KAAR,CAAc,GAAd,EAAmB,IAAnB,EAAyB,KAAzB;;AAEA,IAAI,GAAJ,CAAQ,GAAR,EAAa,UAAU,GAAV,EAAe,GAAf,EAAoB;AAChC,KAAI,OAAO;AACV,QAAM,IAAI,IADA;AAEV,OAAK,IAAI;AAFC,EAAX;;AAKA,KAAI,MAAJ,CAAW,aAAX,EAA0B,IAA1B;AACA,CAPD;;AASA,IAAI,GAAJ,CAAQ,QAAR,EAAkB,UAAU,GAAV,EAAe,GAAf,EAAoB;AACrC,KAAI,gBAAgB,UAAS,GAAT,EAAc,KAAd,EAAqB;AACxC,MAAI,OAAO,CAAC,KAAZ,EAAmB;AAClB,WAAQ,GAAR,CAAY,GAAZ;AACA,UAAO,IAAI,GAAJ,CAAQ,0BAA0B,IAAI,KAAJ,CAAU,EAA5C,CAAP;AACA;;AAED,MAAI,UAAU,KAAd;AAAA,MAAqB,iBAAiB,KAAtC;AAAA,MAA6C,QAA7C;AAAA,MAAuD,MAAvD;AACA,MAAI,IAAI,IAAR,EAAc;AACb,SAAM,MAAN,CAAa,OAAb,CAAqB,UAAS,KAAT,EAAgB;AACpC,QAAI,MAAM,GAAN,CAAU,QAAV,MAAwB,IAAI,IAAJ,CAAS,GAAT,CAAa,QAAb,EAA5B,EAAqD;AACpD,eAAU,IAAV;AACA;AACD,IAJD;;AAMA,SAAM,eAAN,CAAsB,OAAtB,CAA8B,UAAS,KAAT,EAAgB;AAC7C,QAAI,MAAM,GAAN,CAAU,QAAV,MAAwB,IAAI,IAAJ,CAAS,GAAT,CAAa,QAAb,EAA5B,EAAqD;AACpD,eAAU,IAAV;AACA,sBAAiB,IAAjB;AACA;AACD,IALD;AAMA;;AAED,aAAW,IAAI,IAAJ,IAAY,SAAZ,IAAyB,MAAM,MAAN,CAAa,GAAb,CAAiB,QAAjB,MAA+B,IAAI,IAAJ,CAAS,GAAT,CAAa,QAAb,EAAnE;;AAEA,MAAI,SAAS,MAAM,MAAN,IAAgB,IAA7B;AACA,MAAI,YAAY,CAAC,MAAjB,EAAyB;AACxB,SAAM,MAAN,GAAe,IAAf;AACA,SAAM,IAAN,CAAW,UAAS,GAAT,EAAc;AACxB,QAAI,GAAJ,EAAS,QAAQ,GAAR,CAAY,GAAZ;AACT,IAFD;AAGA;;AAEC,MAAI,SAAS,EAAb;AACA,MAAI,IAAI,IAAR,EAAc;AACZ,YAAS,IAAI,IAAJ,CAAS,GAAlB;AACD;;AAEH,MAAI,OAAO;AACV,YAAS,MAAM,GADL;AAEV,SAAM,IAAI,IAFA;AAGP,SAHO,EAGC,MAHD;AAIV,cAAW,KAJD;AAKV,oBAAiB,KAAK,SAAL,CAAe,KAAf,EAAsB,IAAtB,EAA4B,CAA5B,CALP;AAMV,QAAK,IAAI,GANC;AAOV,aAAU,QAPA;AAQV,YAAS,OARC;AASV,mBAAgB,cATN;AAUV,WAAQ,MAVE;AAWP,SAAM,IAAI,KAAJ,CAAU,IAAV,IAAkB,EAXjB;AAYP,WAAQ,IAAI,KAAJ,CAAU,MAAV,IAAoB,EAZrB;AAaP,YAAS,IAAI,KAAJ,CAAU,OAAV,IAAqB;AAbvB,GAAX;;AAgBA,MAAI,MAAJ,CAAW,OAAX,EAAoB,IAApB;AACA,EAtDD;;AAwDA,KAAI,KAAK,IAAI,KAAJ,CAAU,EAAnB;AACA,KAAI,GAAG,MAAH,IAAa,EAAjB,EAAqB;AACpB,QAAM,OAAN,CAAc,EAAC,WAAW,EAAZ,EAAd,EAA+B,QAA/B,CAAwC,QAAxC,EAAkD,QAAlD,CAA2D,QAA3D,EAAqE,QAArE,CAA8E,iBAA9E,EAAiG,IAAjG,CAAsG,aAAtG;AACA,EAFD,MAGK;AACJ,QAAM,QAAN,CAAe,EAAf,EAAmB,QAAnB,CAA4B,QAA5B,EAAsC,QAAtC,CAA+C,QAA/C,EAAyD,QAAzD,CAAkE,iBAAlE,EAAqF,IAArF,CAA0F,aAA1F;AACA;AACD,CAhED;;AAkEA,IAAI,GAAJ,CAAQ,YAAR,EAAsB,UAAU,GAAV,EAAe,GAAf,EAAoB;AACzC,KAAI,CAAC,IAAI,IAAT,EAAe;AACd,SAAO,IAAI,QAAJ,CAAa,6BAA6B,mBAAmB,YAAnB,CAA1C,CAAP;AACA;;AAED,KAAI,OAAO;AACV,QAAM,IAAI,IADA;AAEV,WAAS,KAFC;AAGV,aAAW,KAHD;AAIV,OAAK,IAAI,GAJC;AAKR,iBAAe;AALP,EAAX;;AAQA,KAAI,MAAJ,CAAW,OAAX,EAAoB,IAApB;AACA,CAdD;;AAgBA,IAAI,GAAJ,CAAQ,YAAR,EAAsB,UAAU,GAAV,EAAe,GAAf,EAAoB;AACzC,OAAM,IAAN,CAAW,EAAX,EAAe,UAAS,GAAT,EAAc,MAAd,EAAsB;;AAGlC,MAAI,MAAM,OAAO,GAAP,CAAW,UAAS,CAAT,EAAY;AAC/B,UAAO,EAAE,GAAT;AACD,GAFS,CAAV;;AAIA,MAAI,IAAJ,CAAS,GAAT;AACD,EARF;AASA,CAVD;;AAYA,IAAI,IAAJ,CAAS,iBAAT,EAA4B,UAAS,GAAT,EAAc,GAAd,EAAmB;AAC9C,SAAQ,GAAR,CAAY,cAAZ;AACA,KAAI,CAAC,IAAI,IAAT,EAAe;AACd,SAAO,IAAI,GAAJ,CAAQ,gBAAR,CAAP;AACA;;AAED,OAAM,QAAN,CAAe,IAAI,IAAJ,CAAS,OAAxB,EAAiC,QAAjC,CAA0C,QAA1C,EAAoD,IAApD,CAAyD,UAAS,GAAT,EAAc,KAAd,EAAqB;AAC3E,MAAI,IAAI,IAAJ,CAAS,GAAT,CAAa,QAAb,MAA2B,MAAM,MAAN,CAAa,GAAb,CAAiB,QAAjB,EAA/B,EAA4D;AAC1D;AACD;;AAEH,MAAI,KAAJ;AAAA,MAAW,aAAa,KAAxB;AAAA,MAA+B,iBAAiB,KAAhD;AACA,OAAK,IAAI,IAAI,CAAb,EAAgB,IAAI,MAAM,MAAN,CAAa,MAAjC,EAAyC,GAAzC,EAA8C;AAC7C,OAAI,MAAM,MAAN,CAAa,CAAb,EAAgB,QAAhB,MAA8B,IAAI,IAAJ,CAAS,GAA3C,EAAgD;AAC/C,iBAAa,IAAb;AACI,YAAQ,MAAM,MAAN,CAAa,CAAb,CAAR;AACJ;AACA;AACD;AACD,OAAK,IAAI,IAAI,CAAb,EAAgB,IAAI,MAAM,eAAN,CAAsB,MAA1C,EAAkD,GAAlD,EAAuD;AACtD,OAAI,MAAM,eAAN,CAAsB,CAAtB,EAAyB,QAAzB,MAAuC,IAAI,IAAJ,CAAS,GAApD,EAAyD;AACxD,qBAAiB,IAAjB;AACA,iBAAa,IAAb;AACA;AACA;AACD;;AAED,MAAI,SAAS,IAAI,IAAJ,CAAS,GAAtB;AACA,MAAI,cAAJ,EAAoB;AACnB,WAAQ,GAAR,CAAY,mBAAZ;AACA,UAAO,IAAI,QAAJ,CAAa,gBAAgB,MAAM,OAAN,IAAiB,MAAM,GAAvC,IAA8C,UAA3D,CAAP;AACA;;AAED,MAAI,CAAC,UAAL,EAAiB;AACb,SAAM,MAAN,CAAa,IAAb,CAAkB,MAAlB;AACH;AACD,MAAI,WAAW,MAAM,QAAN,IAAkB,EAAjC;AACA,WAAS,IAAI,IAAJ,CAAS,GAAlB,IAAyB,IAAI,IAAJ,CAAS,OAAlC;AACA,QAAM,QAAN,GAAiB,QAAjB;;AAEE,MAAI,aAAa,MAAM,eAAN,CAAsB,MAAtB,IAAgC,MAAM,KAAvD;AACF,QAAM,WAAN,GAAoB,MAAM,WAAN,IAAqB,EAAzC;AACA,QAAM,WAAN,CAAkB,MAAlB,IAA4B;AAC3B,SAAM,KADqB;AAExB,eAAY;AAFY,GAA5B;AAIA,QAAM,YAAN,CAAmB,UAAnB;AACA,QAAM,YAAN,CAAmB,aAAnB;;AAEE,MAAI,CAAC,UAAL,EAAiB;AAAE;AACjB,OAAI,IAAJ,CAAS,MAAT,GAAkB,IAAI,IAAJ,CAAS,MAAT,IAAmB,EAArC;AACF,OAAI,IAAJ,CAAS,MAAT,CAAgB,IAAhB,CAAqB,KAArB;;AAEE,OAAI,UAAJ,EAAgB;AACd,SAAK,QAAL,CAAc;AACZ,YAAO,KADK;AAEZ,gBAAW,IAAI,IAFH;AAGZ,kBAAa;AACX,kBAAY;AADD;AAHD,KAAd;AAOD,IARD,MASK;AACH,SAAK,QAAL,CAAc,MAAd,EAAsB,UAAS,GAAT,EAAc,SAAd,EAAyB;AAC7C,aAAQ,GAAR,CAAY,OAAZ,EAAqB,SAArB;AACA,UAAK,QAAL,CAAc;AACZ,iBAAW,MAAM,MADL;AAEZ,aAAO,KAFK;AAGZ,aAAO,SAHK;AAIZ,oBAAc;AACZ,mBAAY;AADA;AAJF,MAAd;AAQD,KAVD;;AAYA,SAAK,QAAL,CAAc;AACZ,gBAAW,IAAI,IADH;AAEZ,YAAO,KAFK;AAGZ,kBAAa;AACX,gBAAU;AADC;AAHD,KAAd;AAOD;AACF,GAlCD,MAmCK,CAAC;;AAEL;;AAEH,QAAM,IAAN,CAAW,UAAS,GAAT,EAAc;AACxB,OAAI,GAAJ,EAAS;AAAE,YAAQ,GAAR,CAAY,GAAZ,EAAkB,OAAO,IAAI,GAAJ,CAAQ,IAAI,QAAJ,EAAR,CAAP;AAAiC;AAC9D,OAAI,IAAJ,CAAS,IAAT,CAAc,UAAS,GAAT,EAAc;AAC3B,QAAI,GAAJ,EAAS;AAAE,aAAQ,GAAR,CAAY,GAAZ,EAAkB,OAAO,IAAI,GAAJ,CAAQ,IAAI,QAAJ,EAAR,CAAP;AAAiC;AAC9D,QAAI,GAAJ,CAAQ,EAAR;AACA,IAHD;AAIA,GAND;AAQA,EA1FD;AA2FA,CAjGD;;AAmGA,IAAI,IAAJ,CAAS,oBAAT,EAA+B,UAAS,GAAT,EAAc,GAAd,EAAmB;AACjD,KAAI,CAAC,IAAI,IAAT,EAAe;AACd,SAAO,IAAI,GAAJ,CAAQ,gBAAR,CAAP;AACA;;AAED,KAAI,aAAa,IAAI,IAAJ,CAAS,MAA1B;;AAEA,OAAM,QAAN,CAAe,IAAI,IAAJ,CAAS,OAAxB,EAAiC,UAAS,GAAT,EAAc,KAAd,EAAqB;;AAErD,MAAI,IAAI,IAAJ,CAAS,GAAT,CAAa,QAAb,MAA2B,MAAM,MAAN,CAAa,QAAb,EAA/B,EAAwD;AACvD,WAAQ,GAAR,CAAY,SAAZ;AACA,UAAO,IAAI,GAAJ,CAAQ,SAAR,CAAP;AACA;;AAED,MAAI,UAAU,KAAd;AACA,OAAK,IAAI,IAAI,CAAb,EAAgB,IAAI,MAAM,eAAN,CAAsB,MAA1C,EAAkD,GAAlD,EAAuD;AACtD,OAAI,QAAQ,MAAM,eAAN,CAAsB,CAAtB,CAAZ;AACA,OAAI,MAAM,QAAN,MAAoB,UAAxB,EAAoC;AACnC,cAAU,IAAV;AACA,UAAM,MAAN,CAAa,IAAb,CAAkB,KAAlB;AACA,UAAM,eAAN,CAAsB,MAAtB,CAA6B,CAA7B,EAAgC,CAAhC;AACA;AACA;AACD;;AAED,MAAI,CAAC,OAAL,EAAc;AACb,UAAO,IAAI,QAAJ,CAAa,gBAAgB,MAAM,OAAN,IAAiB,MAAM,GAAvC,IAA8C,UAA3D,CAAP;AACA;AACD,MAAI,WAAW,MAAM,QAAN,IAAkB,EAAjC;AACA,SAAO,SAAS,IAAI,IAAJ,CAAS,GAAlB,CAAP;AACA,QAAM,QAAN,GAAiB,QAAjB;;AAEA,QAAM,WAAN,GAAoB,MAAM,WAAN,IAAqB,EAAzC;AACA,QAAM,WAAN,CAAkB,UAAlB,IAAgC,MAAM,WAAN,CAAkB,UAAlB,KAAiC;AAChE,SAAM;AAD0D,GAAjE;AAGA,QAAM,YAAN,CAAmB,UAAnB;AACA,QAAM,YAAN,CAAmB,aAAnB;;AAEA,QAAM,IAAN,CAAW,UAAS,GAAT,EAAc;AACxB,OAAI,GAAJ,EAAS;AAAE,YAAQ,GAAR,CAAY,GAAZ,EAAkB,OAAO,IAAI,GAAJ,CAAQ,IAAI,QAAJ,EAAR,CAAP;AAAiC;;AAE9D,OAAI,GAAJ,CAAQ,SAAR;AACA,GAJD;AAKA,EArCD;AAsCA,CA7CD;;AA+CA,IAAI,IAAJ,CAAS,sBAAT,EAAiC,UAAS,GAAT,EAAc,GAAd,EAAmB;AACnD,KAAI,CAAC,IAAI,IAAT,EAAe;AACd,SAAO,IAAI,GAAJ,CAAQ,gBAAR,CAAP;AACA;;AAED,KAAI,aAAa,IAAI,IAAJ,CAAS,MAA1B;;AAEA,OAAM,QAAN,CAAe,IAAI,IAAJ,CAAS,OAAxB,EAAiC,UAAS,GAAT,EAAc,KAAd,EAAqB;;AAErD,MAAI,IAAI,IAAJ,CAAS,GAAT,CAAa,QAAb,MAA2B,UAA/B,EAA2C;AAC1C,WAAQ,GAAR,CAAY,SAAZ;AACA,UAAO,IAAI,GAAJ,CAAQ,SAAR,CAAP;AACA;;AAED,MAAI,UAAU,KAAd;AACA,OAAK,IAAI,IAAI,CAAb,EAAgB,IAAI,MAAM,MAAN,CAAa,MAAjC,EAAyC,GAAzC,EAA8C;AAC7C,OAAI,QAAQ,MAAM,MAAN,CAAa,CAAb,CAAZ;AACA,OAAI,MAAM,QAAN,MAAoB,UAAxB,EAAoC;AACnC,cAAU,IAAV;AACA,UAAM,MAAN,CAAa,MAAb,CAAoB,CAApB,EAAuB,CAAvB;AACA;AACA;AACD;;AAED,MAAI,CAAC,OAAL,EAAc;AACb,UAAO,IAAI,QAAJ,CAAa,gBAAgB,MAAM,OAAN,IAAiB,MAAM,GAAvC,IAA8C,UAA3D,CAAP;AACA;AACD,MAAI,WAAW,MAAM,QAAN,IAAkB,EAAjC;AACA,SAAO,SAAS,IAAI,IAAJ,CAAS,GAAlB,CAAP;AACA,QAAM,QAAN,GAAiB,QAAjB;;AAEA,QAAM,WAAN,GAAoB,MAAM,WAAN,IAAqB,EAAzC;AACA,MAAI,MAAM,WAAN,CAAkB,UAAlB,CAAJ,EAAmC;AAC/B,UAAO,MAAM,WAAN,CAAkB,UAAlB,CAAP;AACD;AACH,QAAM,YAAN,CAAmB,UAAnB;AACA,QAAM,YAAN,CAAmB,aAAnB;;AAEA,QAAM,IAAN,CAAW,UAAS,GAAT,EAAc;AACxB,OAAI,GAAJ,EAAS;AAAE,YAAQ,GAAR,CAAY,GAAZ,EAAkB,OAAO,IAAI,GAAJ,CAAQ,IAAI,QAAJ,EAAR,CAAP;AAAiC;;AAE9D,OAAI,GAAJ,CAAQ,SAAR;AACA,GAJD;AAKA,EApCD;AAqCA,CA5CD;;AA8CA,IAAI,IAAJ,CAAS,qBAAT,EAAgC,UAAS,GAAT,EAAc,GAAd,EAAmB;AAClD,KAAI,CAAC,IAAI,IAAT,EAAe;AACd,SAAO,IAAI,GAAJ,CAAQ,gBAAR,CAAP;AACA;;AAED,OAAM,QAAN,CAAe,IAAI,IAAJ,CAAS,OAAxB,EAAiC,QAAjC,CAA0C,QAA1C,EAAoD,QAApD,CAA6D,QAA7D,EAAuE,QAAvE,CAAgF,iBAAhF,EAAmG,IAAnG,CAAwG,UAAS,GAAT,EAAc,KAAd,EAAqB;AAC5H,MAAI,GAAJ,EAAS;AACR,UAAO,IAAI,GAAJ,CAAQ,IAAI,QAAJ,EAAR,CAAP;AACA;;AAED,MAAI,MAAM,MAAN,CAAa,GAAb,CAAiB,QAAjB,MAA+B,IAAI,IAAJ,CAAS,GAAT,CAAa,QAAb,EAAnC,EAA4D;AAC3D,UAAO,IAAI,GAAJ,CAAQ,iBAAR,CAAP;AACA;;AAED,OAAK,IAAI,IAAI,CAAb,EAAgB,IAAI,MAAM,MAAN,CAAa,MAAjC,EAAyC,GAAzC,EAA8C;AAC7C,OAAI,MAAM,MAAN,CAAa,CAAb,EAAgB,EAAhB,IAAsB,IAAI,IAAJ,CAAS,MAAnC,EAA2C;AAC1C,UAAM,MAAN,CAAa,MAAb,CAAoB,CAApB,EAAuB,CAAvB;AACA;AACA;AACD;;AAED,MAAI,QAAQ,KAAZ;AACA,OAAK,IAAI,IAAI,CAAb,EAAgB,IAAI,MAAM,eAAN,CAAsB,MAA1C,EAAkD,GAAlD,EAAuD;AACtD,OAAI,MAAM,eAAN,CAAsB,CAAtB,EAAyB,EAAzB,IAA+B,IAAI,IAAJ,CAAS,MAA5C,EAAoD;AACnD,YAAQ,IAAR;AACA;AACA;AACD;;AAEC,MAAI,aAAa,MAAM,WAAN,CAAkB,IAAI,IAAJ,CAAS,MAA3B,EAAmC,UAApD;AACF,MAAI,CAAC,KAAL,EAAY;AACX,SAAM,eAAN,CAAsB,IAAtB,CAA2B,IAAI,IAAJ,CAAS,MAApC;AACA,SAAM,WAAN,CAAkB,IAAI,IAAJ,CAAS,MAA3B,EAAmC,WAAnC,GAAiD,IAAI,IAAJ,CAAS,KAAK,GAAL,EAAT,CAAjD;AACG,SAAM,WAAN,CAAkB,IAAI,IAAJ,CAAS,MAA3B,EAAmC,UAAnC,GAAgD,KAAhD;AACH,SAAM,YAAN,CAAmB,aAAnB;AACA;;AAEC,OAAK,QAAL,CAAc,IAAI,IAAJ,CAAS,MAAvB,EAA+B,UAAS,GAAT,EAAc,KAAd,EAAqB;AAClD,OAAI,UAAJ,EAAgB;AACd,SAAK,QAAL,CAAc;AACZ,gBAAW,KADC;AAEZ,YAAO,KAFK;AAGZ,kBAAa;AACX,mBAAa;AADF;AAHD,KAAd;AAOD,IARD,MASK;AACH,SAAK,QAAL,CAAc;AACZ,gBAAW,KADC;AAEZ,YAAO,KAFK;AAGZ,kBAAa;AACX,iBAAW;AADA;AAHD,KAAd;AAOD;AACF,GAnBD;;AAsBF,QAAM,IAAN,CAAW,UAAS,GAAT,EAAc;AACxB,OAAI,GAAJ,EAAS;AAAE,WAAO,IAAI,GAAJ,CAAQ,IAAI,QAAJ,EAAR,CAAP;AAAiC;;AAE5C,OAAI,QAAJ,CAAa,gBAAgB,MAAM,OAAN,IAAiB,MAAM,GAAvC,CAAb;AACA,GAJD;AAKA,EA3DD;AA4DA,CAjED;;AAmEA,IAAI,IAAJ,CAAS,kBAAT,EAA6B,UAAS,GAAT,EAAc,GAAd,EAAmB;AAC/C,KAAI,CAAC,IAAI,IAAT,EAAe;AACd;AACA,SAAO,IAAI,QAAJ,CAAa,qBAAb,CAAP;AACA;;AAED,OAAM,QAAN,CAAe,IAAI,IAAJ,CAAS,OAAxB,EAAiC,UAAS,GAAT,EAAc,KAAd,EAAqB;AACrD,MAAI,CAAC,KAAL,EAAY;AAAE,UAAO,IAAI,GAAJ,CAAQ,KAAR,CAAP;AAAwB;;AAEtC,QAAM,WAAN,GAAoB,MAAM,WAAN,IAAqB,EAAzC;AACA,QAAM,WAAN,CAAkB,IAAI,IAAJ,CAAS,GAA3B,IAAkC,MAAM,WAAN,CAAkB,IAAI,IAAJ,CAAS,GAA3B,KAAmC,EAArE;AACA,QAAM,WAAN,CAAkB,IAAI,IAAJ,CAAS,GAA3B,EAAgC,IAAhC,GAAuC,IAAvC;AACA,QAAM,YAAN,CAAmB,aAAnB;;AAEA,OAAK,QAAL,CAAc;AACb,cAAW,MAAM,MADJ;AAEb,iBAAc;AACb,eAAW;AADE;AAFD,GAAd;;AAOA,QAAM,IAAN,CAAW,UAAU,KAAV,EAAiB;AAC3B,OAAI,KAAJ,EAAW;AAAE,YAAQ,GAAR,CAAY,KAAZ,EAAoB,OAAO,IAAI,GAAJ,CAAQ,MAAM,QAAN,EAAR,CAAP;AAAmC;AACpE,OAAI,GAAJ,CAAQ,SAAR;AACA,GAHD;AAIA,EAnBD;AAoBA,CA1BD;;AA4BA,IAAI,IAAJ,CAAS,YAAT,EAAuB,UAAU,GAAV,EAAe,GAAf,EAAoB;AAC1C,KAAI,CAAC,IAAI,IAAT,EAAe;AACd;AACA,SAAO,IAAI,QAAJ,CAAa,qBAAb,CAAP;AACA;;AAED,KAAI,WAAW,IAAI,IAAJ,CAAS,KAAK,GAAL,EAAT,CAAf;AACA,KAAI,OAAO,IAAI,IAAJ,CAAS,IAAI,IAAJ,CAAS,IAAlB,CAAX;;AAEA,KAAI,KAAK,QAAL,KAAkB,SAAS,QAAT,EAAtB,EAA2C;AAC1C,OAAK,OAAL,CAAa,SAAS,OAAT,KAAqB,IAAlC;AACA,EAFD,MAGK;AACJ,OAAK,OAAL,CAAa,SAAS,OAAT,KAAqB,IAAlC;AACA;;AAEA,KAAI,IAAI,IAAI,IAAJ,CAAS,IAAjB;AACA,KAAI,QAAQ,EAAE,KAAF,CAAQ,GAAR,CAAZ;AACA,KAAI,IAAI,SAAS,MAAM,CAAN,CAAT,CAAR;AACA,KAAI,CAAC,MAAM,CAAN,CAAL,EAAe;AACb,MAAI,KAAK,CAAT,EAAY;AACV,OAAK,QAAQ,MAAM,CAAN,CAAR,GAAmB,KAAxB;AACD,GAFD,MAGK,IAAI,IAAI,EAAR,EAAY;AAAE,QAAK,KAAL;AAAa,GAA3B,MACA,IAAI,KAAK,EAAT,EAAa;AAAE,QAAK,KAAL;AAAa,GAA5B,MACA;AACH,OAAI,MAAM,MAAN,GAAe,CAAnB,EAAsB;AAClB,QAAK,IAAE,EAAH,GAAS,GAAT,GAAe,MAAM,CAAN,CAAf,GAA0B,KAA9B;AACH;AACF;AACF;AACD,KAAI,IAAJ,CAAS,IAAT,GAAgB,CAAhB;;AAED,KAAI,QAAJ;AACC,KAAI;AACF,aAAW,MAAM;AACjB,YAAS,OAAO,CAAP,CADQ;AAEjB,WAAQ,IAAI,IAAJ,CAAS,MAFA;AAGjB,gBAAa,IAAI,IAAJ,CAAS,WAHL;AAIjB,UAAO,IAAI,IAAJ,CAAS,KAJC;AAKjB,SAAM,IALW;AAMjB,SAAM,IAAI,IAAJ,CAAS,IANE;AAOjB,WAAQ,IAAI,IAAJ,CAAS,GAPA;AAQjB,WAAO,EARU;AASjB,gBAAa,EATI;AAUjB,oBAAiB,EAVA;AAWjB,aAAU,EAXO;AAYjB,kBAAe,IAAI,IAAJ,CAAS,MAZP;AAajB,0BAAuB,IAAI,IAAJ,CAAS,qBAAT,IAAkC;AAbxC,GAAN,CAAX;AAeD,EAhBD,CAiBA,OAAM,CAAN,EAAS;AACP,MAAI,MAAJ,CAAW,GAAX;AACA,SAAO,IAAI,GAAJ,EAAP;AACD;;AAEF,KAAI,IAAI,IAAJ,CAAS,cAAb,EAA6B;AAC5B,MAAI,IAAJ,CAAS,cAAT,GAA0B,IAAI,IAAJ,CAAS,cAAnC;AACA;AACD,KAAI,IAAJ,CAAS,MAAT,CAAgB,IAAhB,CAAqB,QAArB;AACA,KAAI,IAAJ,CAAS,IAAT,CAAc,UAAS,GAAT,EAAc;AAC3B,MAAI,GAAJ,EAAS,QAAQ,GAAR,CAAY,GAAZ;AACT,EAFD;;AAIA,UAAS,IAAT,CAAc,UAAS,GAAT,EAAa;AAC1B,MAAG,GAAH,EAAQ,MAAM,GAAN;AACR,UAAQ,GAAR,CAAY,gBAAZ;AACE,OAAK,QAAL,CAAc,SAAS,MAAvB,EAA+B,UAAS,GAAT,EAAc,MAAd,EAAsB;AACnD,YAAS,MAAT,GAAkB,MAAlB;AACA,QAAK,QAAL,CAAc;AACf,kBAAc;AACb,mBAAc;AADD,KADC;AAIf,eAAW,IAAI,IAJA;AAKZ,WAAO;AALK,IAAd;AAOA,UAAO,IAAI,GAAJ,CAAQ,gBAAgB,SAAS,OAAT,IAAoB,SAAS,GAA7C,CAAR,CAAP;AACD,GAVD;AAWF,EAdD;AAeA,CA/ED;;AAiFA,IAAI,GAAJ,CAAQ,WAAR,EAAqB,UAAS,GAAT,EAAc,GAAd,EAAmB;AACtC,KAAI,IAAI,IAAI,KAAJ,CAAU,CAAlB;AACA,KAAI,KAAK,GAAT,EAAc;AACZ,OAAK,QAAL,CAAc;AACZ,iBAAc;AACZ,kBAAc;AADF,IADF;AAIZ,OAAI;AAJQ,GAAd;AAMD,EAPD,MAQK,IAAI,KAAK,GAAT,EAAc;AACjB,OAAK,QAAL,CAAc;AACZ,gBAAa;AACX,cAAU;AADC,IADD;AAIZ,OAAI;AAJQ,GAAd;AAMD,EAPI,MAQA,IAAI,KAAK,GAAT,EAAc;AACjB,OAAK,QAAL,CAAc;AACZ,gBAAa;AACX,eAAW;AADA,IADD;AAIZ,OAAI;AAJQ,GAAd;AAMD,EAPI,MAQA,IAAI,KAAG,GAAP,EAAY;AACf,OAAK,QAAL,CAAc;AACZ,gBAAa;AACX,iBAAa;AADF,IADD;AAIZ,OAAI;AAJQ,GAAd;AAMD,EAPI,MAQA,IAAI,KAAG,GAAP,EAAY;AACf,OAAK,QAAL,CAAc;AACZ,gBAAa;AACX,iBAAa;AADF,IADD;AAIZ,WAAQ,EAAC,UAAS,EAAC,MAAM,aAAP,EAAV,EAJI;AAKZ,OAAI;AALQ,GAAd;AAOD,EARI,MASA,IAAI,KAAG,GAAP,EAAY;AACf,OAAK,QAAL,CAAc;AACZ,gBAAa;AACX,iBAAa;AADF,IADD;AAIZ,WAAQ,EAAC,UAAS,EAAC,MAAM,aAAP,EAAV,EAJI;AAKZ,OAAI;AALQ,GAAd;AAOD,EARI,MASA,IAAI,KAAG,GAAP,EAAY;AACf,OAAK,QAAL,CAAc;AACZ,gBAAa;AACX,UAAM;AADK,IADD;AAIZ,WAAQ,EAAC,UAAS,EAAC,MAAM,aAAP,EAAV,EAJI;AAKZ,OAAI;AALQ,GAAd;AAOD,EARI,MASA,IAAI,KAAG,GAAP,EAAY;AACf,OAAK,QAAL,CAAc;AACZ,gBAAa;AACX,sBAAkB;AADP,IADD;AAIZ,WAAQ,EAAC,UAAS,EAAC,MAAM,aAAP,EAAV,EAJI;AAKZ,OAAI;AALQ,GAAd;AAOD,EARI,MASA,IAAI,KAAG,GAAP,EAAY;AACf,OAAK,QAAL,CAAc;AACZ,gBAAa;AACX,2BAAuB;AADZ,IADD;AAIZ,WAAQ,EAAC,UAAS,EAAC,MAAM,aAAP,EAAV,EAJI;AAKZ,OAAI;AALQ,GAAd;AAOD,EARI,MASA,IAAI,KAAG,IAAP,EAAa;AAChB,OAAK,QAAL,CAAc;AACZ,iBAAc;AACZ,gBAAY;AADA,IADF;AAIZ,WAAQ,EAAC,UAAS,EAAC,MAAM,aAAP,EAAV,EAJI;AAKZ,OAAI;AALQ,GAAd;AAOD,EARI,MASA,IAAI,KAAG,IAAP,EAAa;AAChB,OAAK,QAAL,CAAc;AACZ,iBAAc;AACZ,eAAW;AADC,IADF;AAIZ,WAAQ,EAAC,UAAS,EAAC,MAAM,aAAP,EAAV,EAJI;AAKZ,OAAI;AALQ,GAAd;AAOD,EARI,MASA,IAAI,KAAG,IAAP,EAAa;AAChB,OAAK,QAAL,CAAc;AACZ,iBAAc;AACZ,uBAAmB;AADP,IADF;AAIZ,WAAQ,EAAC,UAAS,EAAC,MAAM,aAAP,EAAV,EAJI;AAKZ,OAAI;AALQ,GAAd;AAOD;AACD,KAAI,GAAJ,CAAQ,EAAR;AACD,CA3GD;;AA6GA,IAAI,GAAJ,CAAQ,WAAR,EAAqB,UAAS,GAAT,EAAc,GAAd,EAAmB;AACvC,KAAI,UAAU,IAAI,IAAJ,CAAS;AACpB,cAAY;AACR,WAAQ,+DADA;AAER,aAAU,MAFF;AAGR,YAAS,EAHD;AAIR,WAAQ,aAJA;AAKR,YAAS,mLALD;AAMR,SAAM,kBANE;AAOR,aAAU,CACN;AACI,aAAS;AADb,IADM;AAPF,GADQ;AAcpB,oBAAkB;AAdE,EAAT,CAAd;;AAiBA,SAAQ,IAAR,CAAa,UAAS,GAAT,EAAc;AAC1B,MAAI,GAAJ,EAAS,QAAQ,GAAR,CAAY,GAAZ;AACT,MAAI,GAAJ,CAAQ,UAAU,KAAK,SAAL,CAAe,OAAf,CAAlB;AACA,EAHD;AAIA,CAtBD;;AAwBA,IAAI,GAAJ,CAAQ,QAAR,EAAkB,UAAS,GAAT,EAAc,GAAd,EAAmB;AACpC,MAAK,QAAL,CAAc,0BAAd,EAA0C,UAAS,GAAT,EAAc,IAAd,EAAoB;AAC7D,MAAI,KAAJ,CAAU,IAAV,EAAgB,UAAS,GAAT,EAAc;AAC1B,OAAI,GAAJ,EAAS;AAAE,YAAQ,GAAR,CAAY,GAAZ;AAAmB;AAC9B,UAAO,IAAI,QAAJ,CAAa,GAAb,CAAP;AACD,GAHH;AAIA,EALD;AAMA,CAPD;;AASA,IAAI,GAAJ,CAAQ,SAAR,EAAmB,UAAS,GAAT,EAAc,GAAd,EAAmB;AACrC,MAAK,QAAL,CAAc,0BAAd,EAA0C,UAAS,GAAT,EAAc,IAAd,EAAoB;AAC7D,MAAI,KAAJ,CAAU,IAAV,EAAgB,UAAS,GAAT,EAAc;AAC1B,OAAI,GAAJ,EAAS;AAAE,YAAQ,GAAR,CAAY,GAAZ;AAAmB;AAC9B,UAAO,IAAI,QAAJ,CAAa,GAAb,CAAP;AACD,GAHH;AAIA,EALD;AAMA,CAPD;;AAUA,IAAI,GAAJ,CAAQ,UAAR,EAAoB,UAAS,GAAT,EAAc,GAAd,EAAkB;AACrC,KAAI,MAAJ,CAAW,SAAX;AACA,CAFD;;AAIA,IAAI,GAAJ,CAAQ,aAAR,EAAuB,UAAS,GAAT,EAAc,GAAd,EAAkB;AACxC,KAAI,CAAC,IAAI,IAAT,EAAe;AACd,SAAO,IAAI,QAAJ,CAAa,6BAA6B,mBAAmB,aAAnB,CAA1C,CAAP;AACA;;AAED,OAAM,IAAN,CAAW,EAAE,KAAK,EAAC,KAAI,IAAI,IAAJ,CAAS,MAAd,EAAP,EAAX,EAA0C,UAAS,GAAT,EAAc,MAAd,EAAsB;AAC/D,MAAI,OAAO;AACV,SAAM,IAAI,IAAJ,IAAY,KADR;AAEV,QAAK,IAAI,GAFC;AAGV,WAAQ;AAHE,GAAX;;AAMA,MAAI,MAAJ,CAAW,YAAX,EAAyB,IAAzB;AACA,EARD;AASA,CAdD;;AAgBA,IAAI,GAAJ,CAAQ,QAAR,EAAkB,UAAS,GAAT,EAAc,GAAd,EAAmB;AACpC,MAAK,QAAL,CAAc;AACb,gBAAc;AACb,eAAY;AADC,GADD;AAIb,MAAI;AAJS,EAAd;AAMA,KAAI,GAAJ;AACA,CARD;;AAUA,IAAI,IAAJ,CAAS,eAAT,EAA0B,UAAS,GAAT,EAAc,GAAd,EAAmB;AAC5C,SAAQ,GAAR,CAAY,UAAZ;AACA,KAAI,CAAC,IAAI,IAAT,EAAe;AACd;AACA,SAAO,IAAI,QAAJ,CAAa,qBAAb,CAAP;AACA;;AAGD,OAAM,QAAN,CAAe,IAAI,IAAJ,CAAS,OAAxB,EAAiC,QAAjC,CAA0C,QAA1C,EAAoD,IAApD,CAAyD,UAAS,GAAT,EAAc,KAAd,EAAqB;AAC7E,MAAI,MAAM,MAAN,CAAa,GAAb,CAAiB,QAAjB,MAA+B,IAAI,IAAJ,CAAS,GAAT,CAAa,QAAb,EAAnC,EAA4D;AAC3D,WAAQ,GAAR,CAAY,QAAZ,EAAsB,MAAM,MAAN,CAAa,GAAnC,EAAwC,IAAI,IAAJ,CAAS,GAAjD;AACA,UAAO,IAAI,GAAJ,CAAQ,iBAAR,CAAP;AACA;;AAED,MAAI,WAAW,IAAI,IAAJ,CAAS,QAAxB;AACA,MAAI,cAAc,CAAC,QAAD,EAAW,aAAX,EAA0B,OAA1B,EAAmC,MAAnC,EAA2C,MAA3C,CAAlB;;AAEA,MAAI,CAAC,EAAE,QAAF,CAAW,WAAX,EAAwB,QAAxB,CAAL,EAAwC;AACvC,UAAO,IAAI,GAAJ,CAAQ,SAAR,CAAP;AACA;;AAEC,MAAI,YAAY,EAAhB;AACA,OAAK,IAAI,IAAI,CAAb,EAAgB,IAAI,MAAM,MAAN,CAAa,MAAjC,EAAyC,GAAzC,EAA8C;AAAE,aAAU,IAAV,CAAe,MAAM,MAAN,CAAa,CAAb,CAAf;AAAkC;AAClF,OAAK,IAAI,IAAI,CAAb,EAAgB,IAAI,MAAM,eAAN,CAAsB,MAA1C,EAAkD,GAAlD,EAAuD;AAAE,aAAU,IAAV,CAAe,MAAM,eAAN,CAAsB,CAAtB,CAAf;AAA2C;AACpG,OAAK,IAAL,CAAU,EAAE,KAAK,EAAC,KAAI,SAAL,EAAP,EAAV,EAAmC,UAAS,GAAT,EAAc,MAAd,EAAsB;AACvD,UAAO,OAAP,CAAe,UAAS,KAAT,EAAgB;AAC7B,SAAK,QAAL,CAAc;AACZ,gBAAW,KADC;AAEZ,YAAO,KAFK;AAGZ,cAAS,QAHG;AAIZ,kBAAa;AACX,mBAAa;AADF;AAJD,KAAd;AAQD,IATD;AAUD,GAXD;;AAaA,MAAI,YAAY,MAAhB,EAAwB;AACtB,OAAI,IAAI,IAAI,IAAJ,CAAS,QAAT,CAAR;AACA,OAAI,QAAQ,EAAE,KAAF,CAAQ,GAAR,CAAZ;AACA,OAAI,IAAI,SAAS,MAAM,CAAN,CAAT,CAAR;AACA,OAAI,CAAC,MAAM,CAAN,CAAL,EAAe;AACb,QAAI,KAAK,CAAT,EAAY;AACV,SAAK,QAAQ,MAAM,CAAN,CAAR,GAAmB,KAAxB;AACD,KAFD,MAGK,IAAI,IAAI,EAAR,EAAY;AAAE,UAAK,KAAL;AAAa,KAA3B,MACA,IAAI,KAAK,EAAT,EAAa;AAAE,UAAK,KAAL;AAAa,KAA5B,MACA;AACH,SAAI,MAAM,MAAN,GAAe,CAAnB,EAAsB;AAClB,UAAK,IAAE,EAAH,GAAS,GAAT,GAAe,MAAM,CAAN,CAAf,GAA0B,KAA9B;AACH;AACF;AACF;AACD,OAAI,IAAJ,CAAS,QAAT,IAAqB,CAArB;AACD;AACD,MAAI,IAAI,IAAJ,CAAS,QAAT,KAAsB,IAAI,IAAJ,CAAS,QAAT,KAAsB,EAAhD,EAAoD;AAClD,SAAM,QAAN,IAAkB,IAAI,IAAJ,CAAS,QAAT,CAAlB;AACD;;AAEH,QAAM,IAAN,CAAW,UAAS,GAAT,EAAc;AACxB,OAAI,GAAJ,EAAS;AAAE,YAAQ,GAAR,CAAY,GAAZ;AAAmB;AAC9B,OAAI,GAAJ;AACA,GAHD;AAIA,EAvDD;AAwDA,CAhED;;AAkEA;AACA,IAAI,GAAJ,CAAQ,QAAR,EAAkB,UAAU,GAAV,EAAe,GAAf,EAAoB;AACrC,KAAI,MAAJ,CAAW,uBAAX;AACA,CAFD;;AAIA,SAAS,MAAT,CAAgB,GAAhB,EAAqB;AACpB,KAAI,IAAI,IAAI,KAAJ,CAAU,GAAV,CAAR;AACA,KAAI,SAAS,CAAC,CAAC,EAAD,EAAK,EAAL,CAAD,EAAW,CAAC,EAAD,EAAK,EAAL,CAAX,EAAqB,CAAC,EAAD,EAAK,EAAL,CAArB,CAAb;AAAA,KAA6C,QAAQ,EAArD;AACA,MAAK,IAAI,IAAI,CAAb,EAAgB,IAAI,GAApB,EAAyB,GAAzB,EAA8B;AAC7B,MAAI,SAAS,SAAS,KAAK,MAAL,KAAgB,KAAzB,CAAb;AACA,OAAK,IAAI,IAAI,CAAb,EAAgB,IAAI,OAAO,MAA3B,EAAmC,GAAnC,EAAwC;AACvC,OAAI,SAAS,OAAO,CAAP,EAAU,CAAV,CAAb,EAA2B;AAC1B,MAAE,CAAF,IAAO,OAAO,YAAP,CAAoB,OAAO,CAAP,EAAU,CAAV,IAAe,MAAnC,CAAP;AACA;AACA;AACD,aAAU,OAAO,CAAP,EAAU,CAAV,CAAV;AACA;AACD;;AAED,QAAO,EAAE,IAAF,CAAO,EAAP,CAAP;AACA;;AAED,IAAI,IAAJ,CAAS,iBAAT,EAA4B,UAAS,GAAT,EAAa,GAAb,EAAiB;AAC5C,KAAI,aAAa,eAAe;AAC/B,SAAO,IAAI,IAAJ,CAAS;AADe,EAAf,CAAjB;;AAIA,YAAW,IAAX,CAAgB,UAAS,GAAT,EAAa;AAC5B,MAAG,GAAH,EAAQ,MAAM,GAAN;AACR,SAAO,IAAI,QAAJ,CAAa,GAAb,CAAP;AACA,EAHD;AAIA,CATD;;AAYA,IAAI,MAAJ,CAAW,IAAI,GAAJ,CAAQ,MAAR,CAAX,EAA4B,YAAW;AACtC,SAAQ,GAAR,CAAY,iBAAZ,EAA+B,IAAI,GAAJ,CAAQ,MAAR,CAA/B;AACA,CAFD","file":"index-compiled.js","sourcesContent":["'use strict'\r\nconst express = require('express');\r\nconst bodyParser = require('body-parser');\r\nconst request = require('request');\r\nconst fs = require('fs');\r\nconst mongoose = require('mongoose');\r\nconst cookieParser = require('cookie-parser');\r\nconst session = require('express-session');\r\nconst User = require('./models/User');\r\nconst Route = require('./models/Route');\r\nconst EmailSubscribe = require('./models/EmailSubscribe')\r\nconst _ = require(\"lodash\");\r\nconst app = express();\r\n\r\nconst auth = require(\"./auth\");\r\nconst mail = require(\"./mail\");\r\nconst payment = require(\"./payments\");\r\n\r\nmongoose.Promise = require('bluebird');\r\nvar conn = mongoose.createConnection('ds161169.mlab.com:61169/heroku_9170g7ps');\r\nmongoose.connect('mongodb://victorcheng:victor97@ds161169.mlab.com:61169/heroku_9170g7ps',  {\r\n  server: {\r\n    socketOptions: {\r\n      socketTimeoutMS: 0,\r\n      connectTimeoutMS: 0\r\n    }\r\n  }\r\n});\r\nvar db = mongoose.connection;\r\n\r\n/*\r\nconst isAuthenticated = (req, res, next) =>\r\n\tif (req.isAuthenticated())\r\n\t\treturn next();\r\n\tres.json({});\r\n*/\r\n\r\n\r\ndb.on('error', console.error.bind(console, 'connection error:'));\r\ndb.once('open', function() {\r\n\tconsole.log(\"we're connected!\");\r\n});\r\n\r\n\r\napp.set('port', (process.env.PORT || 5000));\r\napp.set('view engine', 'ejs');\r\n\r\napp.use(express.static(__dirname + '/public'));\r\n// parse application/x-www-form-urlencoded\r\napp.use(bodyParser.urlencoded({extended: false}));\r\n\r\n// parse cookie sessions\r\napp.use(session({\r\n\tresave: true,\r\n\tsaveUninitialized: true,\r\n\tsecret: \"Thisshouldbemademoresecure\"\r\n}));\r\napp.use(cookieParser());\r\n\r\n// parse application/json\r\napp.use(bodyParser.json());\r\n\r\nauth.setUpAuth(app);\r\npayment.setUp(app, mail, Route);\r\n\r\napp.get('/', function (req, res) {\r\n\tvar data = {\r\n\t\tuser: req.user,\r\n\t\turl: req.url\r\n\t};\r\n\r\n\tres.render('new_landing', data);\r\n});\r\n\r\napp.get('/route', function (req, res) {\r\n\tvar handleRequest = function(err, route) {\r\n\t\tif (err || !route) {\r\n\t\t\tconsole.log(err);\r\n\t\t\treturn res.end(\"404 couldn't find id \" + req.query.id);\r\n\t\t}\r\n\r\n\t\tvar isRider = false, confirmedRider = false, isDriver, opened;\r\n\t\tif (req.user) {\r\n\t\t\troute.riders.forEach(function(rider) {\r\n\t\t\t\tif (rider._id.toString() == req.user._id.toString()) {\r\n\t\t\t\t\tisRider = true;\r\n\t\t\t\t}\r\n\t\t\t});\r\n\r\n\t\t\troute.confirmedRiders.forEach(function(rider) {\r\n\t\t\t\tif (rider._id.toString() == req.user._id.toString()) {\r\n\t\t\t\t\tisRider = true;\r\n\t\t\t\t\tconfirmedRider = true;\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tisDriver = req.user != undefined && route.driver._id.toString() == req.user._id.toString();\r\n\r\n\t\tvar opened = route.opened == true;\r\n\t\tif (isDriver && !opened) {\r\n\t\t\troute.opened = true;\r\n\t\t\troute.save(function(err) {\r\n\t\t\t\tif (err) console.log(err);\r\n\t\t\t});\r\n\t\t}\r\n\r\n    var userId = '';\r\n    if (req.user) {\r\n      userId = req.user._id;\r\n    }\r\n\r\n\t\tvar data = {\r\n\t\t\trouteId: route._id,\r\n\t\t\tuser: req.user,\r\n      userId, userId,\r\n\t\t\trouteData: route,\r\n\t\t\trouteDataString: JSON.stringify(route, null, 4),\r\n\t\t\turl: req.url,\r\n\t\t\tisDriver: isDriver,\r\n\t\t\tisRider: isRider,\r\n\t\t\tconfirmedRider: confirmedRider,\r\n\t\t\topened: opened,\r\n      view: req.query.view || \"\",\r\n      action: req.query.action || \"\",\r\n      riderId: req.query.riderId || \"\"\r\n\t\t};\r\n\r\n\t\tres.render('route', data);\r\n\t}\r\n\r\n\tvar id = req.query.id;\r\n\tif (id.length != 24) {\r\n\t\tRoute.findOne({'shortId': id}).populate('driver').populate('riders').populate('confirmedRiders').exec(handleRequest);\r\n\t}\r\n\telse {\r\n\t\tRoute.findById(id).populate('driver').populate('riders').populate('confirmedRiders').exec(handleRequest);\r\n\t}\r\n});\r\n\r\napp.get('/route/new', function (req, res) {\r\n\tif (!req.user) {\r\n\t\treturn res.redirect(\"/auth/facebook?redirect=\" + encodeURIComponent('/route/new'));\r\n\t}\r\n\r\n\tvar data = {\r\n\t\tuser: req.user,\r\n\t\trouteId: false,\r\n\t\trouteData: false,\r\n\t\turl: req.url,\r\n    creatingRoute: true\r\n\t};\r\n\r\n\tres.render('route', data);\r\n});\r\n\r\napp.get('/route/all', function (req, res) {\r\n\tRoute.find({}, function(err, routes) {\r\n\r\n\r\n    var ids = routes.map(function(r) {\r\n      return r._id;\r\n    });\r\n\r\n    res.json(ids);\r\n  });\r\n});\r\n\r\napp.post('/route/addrider', function(req, res) {\r\n\tconsole.log(\"adding rider\");\r\n\tif (!req.user) {\r\n\t\treturn res.end(\"please log in \");\r\n\t}\r\n\r\n\tRoute.findById(req.body.routeId).populate('driver').exec(function(err, route) {\r\n    if (req.user._id.toString() == route.driver._id.toString()) {\r\n      return;\r\n    }\r\n\r\n\t\tvar rider, riderFound = false, confirmedRider = false;\r\n\t\tfor (var i = 0; i < route.riders.length; i++) {\r\n\t\t\tif (route.riders[i].toString() == req.user._id) {\r\n\t\t\t\triderFound = true;\r\n        rider = route.riders[i];\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\t\tfor (var i = 0; i < route.confirmedRiders.length; i++) {\r\n\t\t\tif (route.confirmedRiders[i].toString() == req.user._id) {\r\n\t\t\t\tconfirmedRider = true;\r\n\t\t\t\triderFound = true;\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tvar userId = req.user._id;\r\n\t\tif (confirmedRider) {\r\n\t\t\tconsole.log(\"already confirmed\");\r\n\t\t\treturn res.redirect(\"/route?id=\" + (route.shortId || rotue._id) + \"&error=1\");\r\n\t\t}\r\n\r\n\t\tif (!riderFound) {\r\n      route.riders.push(userId);\r\n\t\t}\r\n\t\tvar dropOffs = route.dropOffs || {};\r\n\t\tdropOffs[req.user._id] = req.body.address;\r\n\t\troute.dropOffs = dropOffs;\r\n\r\n    var onWaitlist = route.confirmedRiders.length == route.seats;\r\n\t\troute.riderStatus = route.riderStatus || {};\r\n\t\troute.riderStatus[userId] = {\r\n\t\t\tpaid: false,\r\n      onWaitlist: onWaitlist\r\n\t\t};\r\n\t\troute.markModified('dropOffs');\r\n\t\troute.markModified('riderStatus');\r\n\r\n    if (!riderFound) { // rider added\r\n      req.user.routes = req.user.routes || [];\r\n  \t\treq.user.routes.push(route);\r\n\r\n      if (onWaitlist) {\r\n        mail.sendMail({\r\n          route: route,\r\n          recipient: req.user,\r\n          notifyRider: {\r\n            onWaitlist: true\r\n          }\r\n        });\r\n      }\r\n      else {\r\n        User.findById(userId, function(err, riderUser) {\r\n          console.log('rider', riderUser);\r\n          mail.sendMail({\r\n            recipient: route.driver,\r\n            route: route,\r\n            rider: riderUser,\r\n            notifyDriver: {\r\n              riderAdded: true\r\n            }\r\n          });\r\n        });\r\n\r\n        mail.sendMail({\r\n          recipient: req.user,\r\n          route: route,\r\n          notifyRider: {\r\n            signedUp: true\r\n          }\r\n        });\r\n      }\r\n    }\r\n    else {// info edited\r\n\r\n    }\r\n\r\n\t\troute.save(function(err) {\r\n\t\t\tif (err) { console.log(err); return res.end(err.toString()); }\r\n\t\t\treq.user.save(function(err) {\r\n\t\t\t\tif (err) { console.log(err); return res.end(err.toString()); }\r\n\t\t\t\tres.end(\"\");\r\n\t\t\t});\r\n\t\t});\r\n\r\n\t});\r\n});\r\n\r\napp.post('/route/removerider', function(req, res) {\r\n\tif (!req.user) {\r\n\t\treturn res.end(\"please log in \");\r\n\t}\r\n\r\n\tvar removingId = req.body.userId;\r\n\r\n\tRoute.findById(req.body.routeId, function(err, route) {\r\n\r\n\t\tif (req.user._id.toString() != route.driver.toString()) {\r\n\t\t\tconsole.log(\"hacking\");\r\n\t\t\treturn res.end(\"failure\");\r\n\t\t}\r\n\r\n\t\tvar removed = false;\r\n\t\tfor (var i = 0; i < route.confirmedRiders.length; i++) {\r\n\t\t\tvar rider = route.confirmedRiders[i];\r\n\t\t\tif (rider.toString() == removingId) {\r\n\t\t\t\tremoved = true;\r\n\t\t\t\troute.riders.push(rider);\r\n\t\t\t\troute.confirmedRiders.splice(i, 1);\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (!removed) {\r\n\t\t\treturn res.redirect(\"/route?id=\" + (route.shortId || rotue._id) + \"&error=2\");\r\n\t\t}\r\n\t\tvar dropOffs = route.dropOffs || {};\r\n\t\tdelete dropOffs[req.user._id]\r\n\t\troute.dropOffs = dropOffs;\r\n\r\n\t\troute.riderStatus = route.riderStatus || {};\r\n\t\troute.riderStatus[removingId] = route.riderStatus[removingId] || {\r\n\t\t\tpaid: false\r\n\t\t};\r\n\t\troute.markModified('dropOffs');\r\n\t\troute.markModified('riderStatus');\r\n\r\n\t\troute.save(function(err) {\r\n\t\t\tif (err) { console.log(err); return res.end(err.toString()); }\r\n\r\n\t\t\tres.end(\"success\");\r\n\t\t})\r\n\t});\r\n});\r\n\r\napp.post('/route/cancelrequest', function(req, res) {\r\n\tif (!req.user) {\r\n\t\treturn res.end(\"please log in \");\r\n\t}\r\n\r\n\tvar removingId = req.body.userId;\r\n\r\n\tRoute.findById(req.body.routeId, function(err, route) {\r\n\r\n\t\tif (req.user._id.toString() != removingId) {\r\n\t\t\tconsole.log(\"hacking\");\r\n\t\t\treturn res.end(\"failure\");\r\n\t\t}\r\n\r\n\t\tvar removed = false;\r\n\t\tfor (var i = 0; i < route.riders.length; i++) {\r\n\t\t\tvar rider = route.riders[i];\r\n\t\t\tif (rider.toString() == removingId) {\r\n\t\t\t\tremoved = true;\r\n\t\t\t\troute.riders.splice(i, 1);\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (!removed) {\r\n\t\t\treturn res.redirect(\"/route?id=\" + (route.shortId || rotue._id) + \"&error=2\");\r\n\t\t}\r\n\t\tvar dropOffs = route.dropOffs || {};\r\n\t\tdelete dropOffs[req.user._id]\r\n\t\troute.dropOffs = dropOffs;\r\n\r\n\t\troute.riderStatus = route.riderStatus || {};\r\n\t\tif (route.riderStatus[removingId]) {\r\n      delete route.riderStatus[removingId];\r\n    }\r\n\t\troute.markModified('dropOffs');\r\n\t\troute.markModified('riderStatus');\r\n\r\n\t\troute.save(function(err) {\r\n\t\t\tif (err) { console.log(err); return res.end(err.toString()); }\r\n\r\n\t\t\tres.end(\"success\");\r\n\t\t})\r\n\t});\r\n});\r\n\r\napp.post('/route/confirmrider', function(req, res) {\r\n\tif (!req.user) {\r\n\t\treturn res.end(\"please log in \");\r\n\t}\r\n\r\n\tRoute.findById(req.body.routeId).populate('driver').populate('riders').populate('confirmedRiders').exec(function(err, route) {\r\n\t\tif (err) {\r\n\t\t\treturn res.end(err.toString());\r\n\t\t}\r\n\r\n\t\tif (route.driver._id.toString() != req.user._id.toString()) {\r\n\t\t\treturn res.end(\"nice try hacker\");\r\n\t\t}\r\n\r\n\t\tfor (var i = 0; i < route.riders.length; i++) {\r\n\t\t\tif (route.riders[i].id == req.body.userId) {\r\n\t\t\t\troute.riders.splice(i, 1);\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tvar found = false;\r\n\t\tfor (var i = 0; i < route.confirmedRiders.length; i++) {\r\n\t\t\tif (route.confirmedRiders[i].id == req.body.userId) {\r\n\t\t\t\tfound = true;\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\r\n    var onWaitlist = route.riderStatus[req.body.userId].onWaitlist;\r\n\t\tif (!found) {\r\n\t\t\troute.confirmedRiders.push(req.body.userId);\r\n\t\t\troute.riderStatus[req.body.userId].confirmedOn = new Date(Date.now());\r\n      route.riderStatus[req.body.userId].onWaitlist = false;\r\n\t\t\troute.markModified('riderStatus');\r\n\t\t}\r\n\r\n    User.findById(req.body.userId, function(err, rider) {\r\n      if (onWaitlist) {\r\n        mail.sendMail({\r\n          recipient: rider,\r\n          route: route,\r\n          notifyRider: {\r\n            offWaitlist: true\r\n          }\r\n        });\r\n      }\r\n      else {\r\n        mail.sendMail({\r\n          recipient: rider,\r\n          route: route,\r\n          notifyRider: {\r\n            confirmed: true\r\n          }\r\n        });\r\n      }\r\n    });\r\n\r\n\r\n\t\troute.save(function(err) {\r\n\t\t\tif (err) { return res.end(err.toString()); }\r\n\r\n\t\t\tres.redirect(\"/route?id=\" + (route.shortId || route._id));\r\n\t\t});\r\n\t});\r\n});\r\n\r\napp.post('/route/riderpaid', function(req, res) {\r\n\tif (!req.user) {\r\n\t\t// TODO Allow user to be informed their session has timed out\r\n\t\treturn res.redirect(\"/youveBeenLoggedOut\");\r\n\t}\r\n\r\n\tRoute.findById(req.body.routeId, function(err, route) {\r\n\t\tif (!route) { return res.end(\"404\"); }\r\n\r\n\t\troute.riderStatus = route.riderStatus || {};\r\n\t\troute.riderStatus[req.user._id] = route.riderStatus[req.user._id] || {}\r\n\t\troute.riderStatus[req.user._id].paid = true;\r\n\t\troute.markModified('riderStatus');\r\n\r\n\t\tmail.sendMail({\r\n\t\t\trecipient: route.driver,\r\n\t\t\tnotifyDriver: {\r\n\t\t\t\triderPaid: true\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\troute.save(function (error) {\r\n\t\t\tif (error) { console.log(error); return res.end(error.toString()); }\r\n\t\t\tres.end(\"success\");\r\n\t\t});\r\n\t});\r\n});\r\n\r\napp.post('/route/new', function (req, res) {\r\n\tif (!req.user) {\r\n\t\t// TODO Allow user to be informed their session has timed out\r\n\t\treturn res.redirect(\"/youveBeenLoggedOut\");\r\n\t}\r\n\r\n\tvar rightNow = new Date(Date.now());\r\n\tvar date = new Date(req.body.date);\r\n\r\n\tif (date.getMonth() < rightNow.getMonth()) {\r\n\t\tdate.setYear(rightNow.getYear() + 1901);\r\n\t}\r\n\telse {\r\n\t\tdate.setYear(rightNow.getYear() + 1900);\r\n\t}\r\n\r\n  var t = req.body.time;\r\n  var parts = t.split(\":\");\r\n  var s = parseInt(parts[0]);\r\n  if (!isNaN(s)) {\r\n    if (s == 0) {\r\n      t =  \"12:\" + parts[1] + \" AM\";\r\n    }\r\n    else if (s < 12) { t += \" AM\"; }\r\n    else if (s == 12) { t += \" PM\"; }\r\n    else {\r\n      if (parts.length > 1) {\r\n          t = (s-12) + \":\" + parts[1] + \" PM\";\r\n      }\r\n    }\r\n  }\r\n  req.body.time = t;\r\n\r\n\tvar newRoute;\r\n  try {\r\n    newRoute = Route({\r\n  \t\tshortId: random(5),\r\n  \t\torigin: req.body.origin,\r\n  \t\tdestination: req.body.destination,\r\n  \t\tseats: req.body.seats,\r\n  \t\tdate: date,\r\n  \t\ttime: req.body.time,\r\n  \t\tdriver: req.user._id,\r\n  \t\triders:[],\r\n  \t\triderStatus: {},\r\n  \t\tconfirmedRiders: [],\r\n  \t\tdropOffs: {},\r\n  \t\tinconvenience: req.body.charge,\r\n  \t\trequireInitialDeposit: req.body.requireInitialDeposit == \"on\"\r\n  \t});\r\n  }\r\n  catch(e) {\r\n    res.status(400);\r\n    return res.end();\r\n  }\r\n\r\n\tif (req.body.confirmedEmail) {\r\n\t\treq.user.confirmedEmail = req.body.confirmedEmail;\r\n\t}\r\n\treq.user.routes.push(newRoute);\r\n\treq.user.save(function(err) {\r\n\t\tif (err) console.log(err);\r\n\t});\r\n\r\n\tnewRoute.save(function(err){\r\n\t\tif(err) throw err;\r\n\t\tconsole.log(\"Route created!\");\r\n    User.findById(newRoute.driver, function(err, driver) {\r\n      newRoute.driver = driver;\r\n      mail.sendMail({\r\n  \t\t\tnotifyDriver: {\r\n  \t\t\t\trouteCreated: true\r\n  \t\t\t},\r\n  \t\t\trecipient: req.user,\r\n        route: newRoute\r\n  \t\t});\r\n      return res.end(\"/route?id=\" + (newRoute.shortId || newRoute._id));\r\n    });\r\n\t});\r\n});\r\n\r\napp.get('/sendMail', function(req, res) {\r\n  var n = req.query.n;\r\n  if (n == \"1\") {\r\n    mail.sendMail({\r\n      notifyDriver: {\r\n        routeCreated: true\r\n      },\r\n      to: 'pmh192@gmail.com'\r\n    });\r\n  }\r\n  else if (n == \"2\") {\r\n    mail.sendMail({\r\n      notifyRider: {\r\n        signedUp: true\r\n      },\r\n      to: 'pmh192@gmail.com'\r\n    });\r\n  }\r\n  else if (n == \"3\") {\r\n    mail.sendMail({\r\n      notifyRider: {\r\n        confirmed: true\r\n      },\r\n      to: 'pmh192@gmail.com'\r\n    });\r\n  }\r\n  else if (n==\"4\") {\r\n    mail.sendMail({\r\n      notifyRider: {\r\n        offWaitlist: true\r\n      },\r\n      to: 'pmh192@gmail.com'\r\n    });\r\n  }\r\n  else if (n==\"5\") {\r\n    mail.sendMail({\r\n      notifyRider: {\r\n        infoChanged: true\r\n      },\r\n      driver: {facebook:{name: \"Porter Haet\"} },\r\n      to: 'pmh192@gmail.com'\r\n    });\r\n  }\r\n  else if (n==\"6\") {\r\n    mail.sendMail({\r\n      notifyRider: {\r\n        offWaitlist: true\r\n      },\r\n      driver: {facebook:{name: \"Porter Haet\"} },\r\n      to: 'pmh192@gmail.com'\r\n    });\r\n  }\r\n  else if (n==\"7\") {\r\n    mail.sendMail({\r\n      notifyRider: {\r\n        paid: true\r\n      },\r\n      driver: {facebook:{name: \"Porter Haet\"} },\r\n      to: 'pmh192@gmail.com'\r\n    });\r\n  }\r\n  else if (n==\"8\") {\r\n    mail.sendMail({\r\n      notifyRider: {\r\n        shouldBePickedUp: true\r\n      },\r\n      driver: {facebook:{name: \"Porter Haet\"} },\r\n      to: 'pmh192@gmail.com'\r\n    });\r\n  }\r\n  else if (n==\"9\") {\r\n    mail.sendMail({\r\n      notifyRider: {\r\n        joinedFeatureWaitlist: true\r\n      },\r\n      driver: {facebook:{name: \"Porter Haet\"} },\r\n      to: 'pmh192@gmail.com'\r\n    });\r\n  }\r\n  else if (n==\"10\") {\r\n    mail.sendMail({\r\n      notifyDriver: {\r\n        riderAdded: true\r\n      },\r\n      driver: {facebook:{name: \"Porter Haet\"} },\r\n      to: 'pmh192@gmail.com'\r\n    });\r\n  }\r\n  else if (n==\"11\") {\r\n    mail.sendMail({\r\n      notifyDriver: {\r\n        riderPaid: true\r\n      },\r\n      driver: {facebook:{name: \"Porter Haet\"} },\r\n      to: 'pmh192@gmail.com'\r\n    });\r\n  }\r\n  else if (n==\"12\") {\r\n    mail.sendMail({\r\n      notifyDriver: {\r\n        shouldBePickingUp: true\r\n      },\r\n      driver: {facebook:{name: \"Porter Haet\"} },\r\n      to: 'pmh192@gmail.com'\r\n    });\r\n  }\r\n  res.end(\"\");\r\n});\r\n\r\napp.get('/testing2', function(req, res) {\r\n\tvar newUser = new User({\r\n    \"facebook\": {\r\n        \"link\": \"https://www.facebook.com/app_scoped_user_id/1275391965875712/\",\r\n        \"gender\": \"male\",\r\n        \"email\": \"\",\r\n        \"name\": \"Porter Haet\",\r\n        \"token\": \"EAAP9KxoqCucBAMF22hAWQD5cNryPVRSAsAVy0qIGgMMKH8AkIMiucu8HbJJHYTa1ZBjFnfGiVv1wnIqcjZAMHmIUuSEHJtsZAdeCmyDHwvZAxQOrJpMrOFh9fvZAxxqHFcZAzMlWHVWCPh9MBFSYGFNLGMEO5xzzqo0aa3TyRhOwZDZD\",\r\n        \"id\": \"1275391965875713\",\r\n        \"photos\": [\r\n            {\r\n                \"value\": \"https://scontent.xx.fbcdn.net/v/t1.0-1/p50x50/12729183_959477910800454_5056109822890601521_n.jpg?oh=ce58e8e7a372cbc9e18bab4f24409c4d&oe=59661BB4\"\r\n            }\r\n        ]\r\n    },\r\n    \"confirmedEmail\": \"pmh192@gmail.com\"\r\n\t});\r\n\r\n\tnewUser.save(function(err) {\r\n\t\tif (err) console.log(err);\r\n\t\tres.end(\"saved\" + JSON.stringify(newUser));\r\n\t});\r\n});\r\n\r\napp.get('/test3', function(req, res) {\r\n\tUser.findById('58c8ec46ceda60e82de5f850', function(err, user) {\r\n\t\treq.logIn(user, function(err) {\r\n      if (err) { console.log(err); }\r\n      return res.redirect('/');\r\n    });\r\n\t});\r\n});\r\n\r\napp.get('/test32', function(req, res) {\r\n\tUser.findById('58c0794d632def07581d19da', function(err, user) {\r\n\t\treq.logIn(user, function(err) {\r\n      if (err) { console.log(err); }\r\n      return res.redirect('/');\r\n    });\r\n\t});\r\n});\r\n\r\n\r\napp.get('/profile', function(req, res){\r\n\tres.render('profile');\r\n});\r\n\r\napp.get('/route/mine', function(req, res){\r\n\tif (!req.user) {\r\n\t\treturn res.redirect(\"/auth/facebook?redirect=\" + encodeURIComponent('/route/mine'));\r\n\t}\r\n\r\n\tRoute.find({ _id: {$in:req.user.routes}}, function(err, routes) {\r\n\t\tvar data = {\r\n\t\t\tuser: req.user || false,\r\n\t\t\turl: req.url,\r\n\t\t\troutes: routes\r\n\t\t};\r\n\r\n\t\tres.render('userRoutes', data);\r\n\t});\r\n});\r\n\r\napp.get('/test4', function(req, res) {\r\n\tmail.sendMail({\r\n\t\tnotifyDriver: {\r\n\t\t\triderAdded: true\r\n\t\t},\r\n\t\tto: 'pmh192@gmail.com'\r\n\t});\r\n\tres.end();\r\n});\r\n\r\napp.post('/route/update', function(req, res) {\r\n\tconsole.log('updating');\r\n\tif (!req.user) {\r\n\t\t// TODO Allow user to be informed their session has timed out\r\n\t\treturn res.redirect(\"/youveBeenLoggedOut\");\r\n\t}\r\n\r\n\r\n\tRoute.findById(req.body.routeId).populate('driver').exec(function(err, route) {\r\n\t\tif (route.driver._id.toString() != req.user._id.toString()) {\r\n\t\t\tconsole.log('hacker', route.driver._id, req.user._id);\r\n\t\t\treturn res.end(\"nice try hacker\");\r\n\t\t}\r\n\r\n\t\tvar updating = req.body.updating;\r\n\t\tvar allowedKeys = [\"origin\", \"destination\", \"seats\", \"date\", \"time\"];\r\n\r\n\t\tif (!_.includes(allowedKeys, updating)) {\r\n\t\t\treturn res.end(\"failure\");\r\n\t\t}\r\n\r\n    var allRiders = [];\r\n    for (var i = 0; i < route.riders.length; i++) { allRiders.push(route.riders[i]); }\r\n    for (var i = 0; i < route.confirmedRiders.length; i++) { allRiders.push(route.confirmedRiders[i]); }\r\n    User.find({ _id: {$in:allRiders}}, function(err, riders) {\r\n      riders.forEach(function(rider) {\r\n        mail.sendMail({\r\n          recipient: rider,\r\n          route: route,\r\n          changed: updating,\r\n          notifyRider: {\r\n            infoChanged: true\r\n          }\r\n        });\r\n      });\r\n    });\r\n\r\n    if (updating == \"time\") {\r\n      var t = req.body[updating];\r\n      var parts = t.split(\":\");\r\n      var s = parseInt(parts[0]);\r\n      if (!isNaN(s)) {\r\n        if (s == 0) {\r\n          t =  \"12:\" + parts[1] + \" AM\";\r\n        }\r\n        else if (s < 12) { t += \" AM\"; }\r\n        else if (s == 12) { t += \" PM\"; }\r\n        else {\r\n          if (parts.length > 1) {\r\n              t = (s-12) + \":\" + parts[1] + \" PM\";\r\n          }\r\n        }\r\n      }\r\n      req.body[updating] = t;\r\n    }\r\n    if (req.body[updating] && req.body[updating] != \"\") {\r\n      route[updating] = req.body[updating];\r\n    }\r\n\r\n\t\troute.save(function(err) {\r\n\t\t\tif (err) { console.log(err); }\r\n\t\t\tres.end();\r\n\t\t})\r\n\t});\r\n});\r\n\r\n// For testing purposes only\r\napp.get('/rider', function (req, res) {\r\n\tres.render('partials/driver_input');\r\n});\r\n\r\nfunction random(len) {\r\n\tvar a = new Array(len);\r\n\tvar ranges = [[48, 10], [65, 26], [97, 26]], total = 62;\r\n\tfor (var i = 0; i < len; i++) {\r\n\t\tvar random = parseInt(Math.random() * total);\r\n\t\tfor (var n = 0; n < ranges.length; n++) {\r\n\t\t\tif (random < ranges[n][1]) {\r\n\t\t\t\ta[i] = String.fromCharCode(ranges[n][0] + random);\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\trandom -= ranges[n][1];\r\n\t\t}\r\n\t}\r\n\r\n\treturn a.join('');\r\n}\r\n\r\napp.post('/emailsubscribe', function(req,res){\r\n\tvar subscriber = EmailSubscribe({\r\n\t\temail: req.body.email\r\n\t});\r\n\r\n\tsubscriber.save(function(err){\r\n\t\tif(err) throw err;\r\n\t\treturn res.redirect(\"/\");\r\n\t});\r\n});\r\n\r\n\r\napp.listen(app.get('port'), function() {\r\n\tconsole.log('running on port', app.get('port'))\r\n});\r\n"]}