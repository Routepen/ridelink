{"version":3,"sources":["index.js"],"names":[],"mappings":"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","file":"index-compiled.js","sourcesContent":["'use strict'\r\nconst express = require('express');\r\nconst bodyParser = require('body-parser');\r\nconst request = require('request');\r\nconst fs = require('fs');\r\nconst mongoose = require('mongoose');\r\nconst passport = require('passport');\r\nconst cookieParser = require('cookie-parser');\r\nconst session = require('express-session');\r\nconst FacebookStrategy = require('passport-facebook').Strategy;\r\nconst User = require('./models/User');\r\nconst Route = require('./models/Route');\r\nconst _ = require(\"lodash\");\r\nconst app = express();\r\n\r\nmongoose.Promise = require('bluebird');\r\nvar conn = mongoose.createConnection('ds161169.mlab.com:61169/heroku_9170g7ps');\r\nmongoose.connect('mongodb://victorcheng:victor97@ds161169.mlab.com:61169/heroku_9170g7ps');\r\nvar db = mongoose.connection;\r\n\r\n/*\r\nconst isAuthenticated = (req, res, next) =>\r\n\tif (req.isAuthenticated())\r\n\t\treturn next();\r\n\tres.json({});\r\n*/\r\n\r\n\r\ndb.on('error', console.error.bind(console, 'connection error:'));\r\ndb.once('open', function() {\r\n\tconsole.log(\"we're connected!\");\r\n});\r\n\r\n\r\napp.set('port', (process.env.PORT || 5000));\r\napp.set('view engine', 'ejs');\r\n\r\napp.use(express.static(__dirname + '/public'));\r\n// parse application/x-www-form-urlencoded\r\napp.use(bodyParser.urlencoded({extended: false}));\r\n\r\n// parse cookie sessions\r\napp.use(session({\r\n\tresave: true,\r\n\tsaveUninitialized: true,\r\n\tsecret: \"Thisshouldbemademoresecure\"\r\n}));\r\napp.use(cookieParser());\r\n\r\n// parse application/json\r\napp.use(bodyParser.json());\r\napp.use(passport.initialize());\r\napp.use(passport.session());\r\n\r\npassport.serializeUser(function(user, done) {\r\n\tdone(null, user._id);\r\n});\r\n\r\npassport.deserializeUser(function(id, done) {\r\n\tUser.findById(id, function(err, user) {\r\n\t\tdone(err, user);\r\n\t});\r\n});\r\n\r\n\r\npassport.use(new FacebookStrategy({\r\n\t\tclientID: \"1122786494515943\",\r\n\t\tclientSecret: \"f6cd89a5fe00867021469477156f95a6\",\r\n\t\tcallbackURL: \"http://localhost:5000/auth/facebook/callback\",\r\n\t\tprofileFields: ['id', 'first_name', 'last_name', 'photos', 'email', 'gender', 'link']\r\n\t},\r\n\tfunction(accessToken, refreshToken, profile, done) {\r\n\t\tconsole.log(profile);\r\n\t\tprocess.nextTick(function(){\r\n\t\t\tUser.findOne({ 'facebook.id': profile.id}, function (err, user) {\r\n\t\t\t\tif (err)\r\n\t\t\t\t\treturn done(err);\r\n\t\t\t\telse if (user) {\r\n\t\t\t\t\treturn done(null, user);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tvar newUser = new User();\r\n\t\t\t\t\tnewUser.facebook.id = profile.id;\r\n\t\t\t\t\tnewUser.facebook.token = accessToken;\r\n\t\t\t\t\tnewUser.facebook.name = profile.name.givenName + ' ' + profile.name.familyName;\r\n\t\t\t\t\tnewUser.facebook.email = (_.get(profile, 'emails[0].value', '')).toLowerCase();\r\n\t\t\t\t\tnewUser.facebook.photos = profile.photos;\r\n\t\t\t\t\tnewUser.facebook.gender = profile.gender;\r\n\t\t\t\t\tnewUser.facebook.link = profile.profileUrl;\r\n\r\n\t\t\t\t\tnewUser.save(function(err) {\r\n\t\t\t\t\t\tif (err)\r\n\t\t\t\t\t\t\tthrow err;\r\n\t\t\t\t\t\treturn done(null, newUser);\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t\treturn;\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n));\r\n\r\napp.get('/', function (req, res) {\r\n\tvar data = {\r\n\t\tuser: req.user,\r\n\t\turl: req.url\r\n\t};\r\n\r\n\tres.render('landing', data);\r\n});\r\n\r\napp.get('/route', function (req, res) {\r\n\tRoute.findById(req.query.id).populate('driver').populate('riders').exec(function(err, route) {\r\n\t\tif (err || !route) {\r\n\t\t\tconsole.log(err);\r\n\t\t\treturn res.end(\"404 couldn't find id \" + req.query.id);\r\n\t\t}\r\n\r\n\t\tvar data = {\r\n\t\t\trouteId: req.query.id,\r\n\t\t\tuser: req.user,\r\n\t\t\trouteData: route,\r\n\t\t\turl: req.url,\r\n\t\t};\r\n\r\n\t\tconsole.log(JSON.stringify(route, null, 4));\r\n\r\n\t\tres.render('route', data);\r\n\t});\r\n});\r\n\r\napp.get('/route/new', function (req, res) {\r\n\tif (!req.user) {\r\n\t\treturn res.redirect(\"/auth/facebook\")\r\n\t}\r\n\tvar data = {\r\n\t\tuser: req.user,\r\n\t\trouteId: false,\r\n\t\trouteData: false,\r\n\t\turl: req.url\r\n\t};\r\n\r\n\tres.render('route', data);\r\n});\r\n\r\napp.get('/route/all', function (req, res) {\r\n\tRoute.find({}, function(err, routes) {\r\n\r\n\r\n    var ids = routes.map(function(r) {\r\n      return r._id;\r\n    });\r\n\r\n    res.json(ids);\r\n  });\r\n});\r\n\r\napp.post('/route/addrider', function(req, res) {\r\n\tif (!req.user) {\r\n\t\treturn res.end(\"please log in \");\r\n\t}\r\n\r\n\tRoute.findById(req.body.routeId, function(err, route) {\r\n\t\tconsole.log(route);\r\n\t\troute.riders.push(req.user._id);\r\n\t\troute.dropOffs = route.dropOffs || {};\r\n\t\troute.dropOffs[req.user._id] = req.body.address;\r\n\r\n\t\troute.save(function(err) {\r\n\t\t\tif (err) { return res.end(err.toString()); }\r\n\r\n\t\t\tres.redirect(\"/route?id=\" + route._id);\r\n\t\t})\r\n\t});\r\n});\r\n\r\napp.post('/route/confirmrider', function(req, res) {\r\n\tif (!req.user) {\r\n\t\treturn res.end(\"please log in \");\r\n\t}\r\n\r\n\tRoute.findById(req.body.routeId).populate('driver').populate('riders').populate('confirmedRiders').exec(function(err, route) {\r\n\t\tif (err) {\r\n\t\t\treturn res.end(err.toString());\r\n\t\t}\r\n\t\tif (route.driver._id.toString() != req.user._id.toString()) {\r\n\t\t\treturn res.end(\"nice try hacker\");\r\n\t\t}\r\n\r\n\t\tfor (var i = 0; i < route.riders.length; i++) {\r\n\t\t\tconsole.log(route.riders[i].id, route.riders[i]._id);\r\n\t\t\tif (route.riders[i].id == req.body.userId) {\r\n\t\t\t\troute.riders.splice(i, 1);\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tvar found = false;\r\n\t\tfor (var i = 0; i < route.confirmedRiders.length; i++) {\r\n\t\t\tif (route.confirmedRiders[i].id == req.body.userId) {\r\n\t\t\t\tfound = true;\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (!found) route.confirmedRiders.push(req.body.userId);\r\n\r\n\t\troute.save(function(err) {\r\n\t\t\tif (err) { return res.end(err.toString()); }\r\n\r\n\t\t\tres.redirect(\"/route?id=\" + route._id);\r\n\t\t})\r\n\t});\r\n});\r\n\r\napp.post('/route/new', function (req, res) {\r\n\tif (!req.user) {\r\n\t\t// TODO Allow user to be informed their session has timed out\r\n\t\treturn res.redirect(\"/youveBeenLoggedOut\");\r\n\t}\r\n\r\n\tvar newRoute = Route({\r\n\t\torigin: req.body.origin,\r\n\t\tdestination: req.body.destination,\r\n\t\tseats: req.body.seats,\r\n\t\tdate: new Date(req.body.date),\r\n\t\tdriver: req.user._id,\r\n\t\triders:[],\r\n\t\tconfirmedRiders: [],\r\n\t\tdropOffs: {},\r\n\t});\r\n\r\n\tnewRoute.save(function(err){\r\n\t\tif(err) throw err;\r\n\t\tconsole.log(\"Route created!\");\r\n\t\treturn res.redirect(\"/route?id=\" + newRoute._id);\r\n\t});\r\n});\r\n\r\n// For testing purposes only\r\napp.get('/rider', function (req, res) {\r\n\tres.render('partials/driver_input');\r\n});\r\n\r\n\r\n\r\napp.get('/profile', function(req,res){\r\n\tres.send(\"hello\");\r\n});\r\n\r\napp.get('/auth/logout', function(req, res) {\r\n\treq.logout();\r\n\tres.redirect(\"/\");\r\n});\r\n\r\napp.get('/auth/facebook', function(req,res,next){\r\n\tconsole.log('/auth/facebook/callback?redirect=' + encodeURIComponent(req.query.redirect));\r\n\tpassport.authenticate(\r\n\t\t'facebook',\r\n\t\t{callbackURL: '/auth/facebook/callback?redirect=' + encodeURIComponent(req.query.redirect) },\r\n\t\t{scope:[\"public_profile,email\"]}\r\n\t)(req,res,next);\r\n});\r\n\r\napp.get('/auth/facebook/callback/', function(req,res,next) {\r\n\tconsole.log('/auth/facebook/callback?redirect=' + encodeURIComponent(req.query.redirect));\r\n\tpassport.authenticate(\r\n\t\t'facebook',\r\n\t\t{\r\n\t\t\tcallbackURL: '/auth/facebook/callback?redirect=' + encodeURIComponent(req.query.redirect),\r\n\t\t\tsuccessRedirect: req.query.redirect,\r\n\t\t\tfailureRedirect: '/'\r\n\t\t}\r\n\t)(req,res,next);\r\n});\r\napp.get('/logout', function(req,res){\r\n\r\n});\r\n\r\napp.get('/rider/', function(req,res){\r\n\r\n});\r\n\r\napp.get('/test/', function(req,res){\r\n\tres.render('')\r\n});\r\n\r\napp.listen(app.get('port'), function() {\r\n\tconsole.log('running on port', app.get('port'))\r\n});\r\n"]}